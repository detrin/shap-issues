{
  "url": "https://api.github.com/repos/shap/shap/issues/1986",
  "repository_url": "https://api.github.com/repos/shap/shap",
  "labels_url": "https://api.github.com/repos/shap/shap/issues/1986/labels{/name}",
  "comments_url": "https://api.github.com/repos/shap/shap/issues/1986/comments",
  "events_url": "https://api.github.com/repos/shap/shap/issues/1986/events",
  "html_url": "https://github.com/shap/shap/issues/1986",
  "id": 880088005,
  "node_id": "MDU6SXNzdWU4ODAwODgwMDU=",
  "number": 1986,
  "title": "Additivity check failed in TreeExplainer!",
  "user": {
    "login": "tjsanti",
    "id": 69698117,
    "node_id": "MDQ6VXNlcjY5Njk4MTE3",
    "avatar_url": "https://avatars.githubusercontent.com/u/69698117?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tjsanti",
    "html_url": "https://github.com/tjsanti",
    "followers_url": "https://api.github.com/users/tjsanti/followers",
    "following_url": "https://api.github.com/users/tjsanti/following{/other_user}",
    "gists_url": "https://api.github.com/users/tjsanti/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tjsanti/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tjsanti/subscriptions",
    "organizations_url": "https://api.github.com/users/tjsanti/orgs",
    "repos_url": "https://api.github.com/users/tjsanti/repos",
    "events_url": "https://api.github.com/users/tjsanti/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tjsanti/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2021-05-08T01:56:43Z",
  "updated_at": "2023-05-21T23:54:19Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "I'm using shap version 0.39.0 in python 3.8.2 and getting this error when trying to do a simple classification task. As far as I can tell, it does not happen with other regression tasks that I have tried. Regardless, here is the code to reproduce this:\r\n```\r\nimport shap\r\nimport numpy as np\r\nimport pandas as pd\r\nfrom sklearn.datasets import load_iris\r\nfrom sklearn.ensemble import RandomForestClassifier\r\n\r\n\r\ndef shap_importance(model, X_train, y_train):\r\n    model.fit(X_train, y_train)\r\n    ex = shap.Explainer(model, X_train)\r\n    shap_values = np.array(ex.shap_values(X_train))\r\n    if len(shap_values.shape) > 2:\r\n        avg_shaps = np.abs(shap_values).sum(axis=0).mean(axis=0)\r\n    else:\r\n        avg_shaps = np.abs(shap_values).mean(axis=0)\r\n    imps = pd.Series(data=avg_shaps, index=X_train.columns)\r\n\r\n    return imps.sort_values(ascending=False)\r\n\r\n\r\niris = load_iris(as_frame=True)\r\nX = iris.data\r\ny = iris.target\r\n\r\nmodel = RandomForestClassifier()\r\nprint(shap_importance(model, X, y))\r\n```\r\nAnd here is the traceback:\r\n```\r\nTraceback (most recent call last):\r\n  File \"issue.py\", line 26, in <module>\r\n    print(shap_importance(model, X, y))\r\n  File \"issue.py\", line 11, in shap_importance\r\n    shap_values = np.array(ex.shap_values(X_train))\r\n  File \"/opt/anaconda3/lib/python3.8/site-packages/shap/explainers/_tree.py\", line 406, in shap_values\r\n    self.assert_additivity(out, self.model.predict(X))\r\n  File \"/opt/anaconda3/lib/python3.8/site-packages/shap/explainers/_tree.py\", line 537, in assert_additivity\r\n    check_sum(self.expected_value[i] + phi[i].sum(-1), model_output[:,i])\r\n  File \"/opt/anaconda3/lib/python3.8/site-packages/shap/explainers/_tree.py\", line 533, in check_sum\r\n    raise Exception(err_msg)\r\nException: Additivity check failed in TreeExplainer! Please ensure the data matrix you passed to the explainer is the same shape that the model was trained on. If your data shape is correct then please report this on GitHub. This check failed because for one of the samples the sum of the SHAP values was 0.000100, while the model output was 0.010000. If this difference is acceptable you can set check_additivity=False to disable this check.\r\n```\r\nAdditionally, when I try to set `check_additivity=False` inside `shap_values` I get: `shap_values() got an unexpected keyword argument 'check_additivity'`",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/shap/shap/issues/1986/reactions",
    "total_count": 5,
    "+1": 5,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/shap/shap/issues/1986/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
