{
  "url": "https://api.github.com/repos/shap/shap/issues/2776",
  "repository_url": "https://api.github.com/repos/shap/shap",
  "labels_url": "https://api.github.com/repos/shap/shap/issues/2776/labels{/name}",
  "comments_url": "https://api.github.com/repos/shap/shap/issues/2776/comments",
  "events_url": "https://api.github.com/repos/shap/shap/issues/2776/events",
  "html_url": "https://github.com/shap/shap/issues/2776",
  "id": 1461177336,
  "node_id": "I_kwDOBHDcK85XF8v4",
  "number": 2776,
  "title": "Could not compile cuda extensions on Linux Ubuntu 20.04",
  "user": {
    "login": "MichaelChaoLi-cpu",
    "id": 78419225,
    "node_id": "MDQ6VXNlcjc4NDE5MjI1",
    "avatar_url": "https://avatars.githubusercontent.com/u/78419225?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/MichaelChaoLi-cpu",
    "html_url": "https://github.com/MichaelChaoLi-cpu",
    "followers_url": "https://api.github.com/users/MichaelChaoLi-cpu/followers",
    "following_url": "https://api.github.com/users/MichaelChaoLi-cpu/following{/other_user}",
    "gists_url": "https://api.github.com/users/MichaelChaoLi-cpu/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/MichaelChaoLi-cpu/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/MichaelChaoLi-cpu/subscriptions",
    "organizations_url": "https://api.github.com/users/MichaelChaoLi-cpu/orgs",
    "repos_url": "https://api.github.com/users/MichaelChaoLi-cpu/repos",
    "events_url": "https://api.github.com/users/MichaelChaoLi-cpu/events{/privacy}",
    "received_events_url": "https://api.github.com/users/MichaelChaoLi-cpu/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2022-11-23T07:14:18Z",
  "updated_at": "2023-05-08T21:40:51Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "Hi, all,\r\n\r\nThank you for reading my issue.\r\n\r\nI am trying to install ```shap``` and use GPU to accelerate. I follow this:\r\n\r\nCheck to makes sure you have the NVIDA CUDA Toolkit installed by running the nvcc command (the CUDA compiler) from the terminal. If this command is not found then you need to install it with something like sudo apt install nvidia-cuda-toolkit.\r\n\r\nOnce the NVIDA CUDA Toolkit is installed you need to set the CUDA_PATH environment variable. If which nvcc produces /usr/bin/nvcc then you can run ```export CUDA_PATH=/usr```.\r\n\r\nBuild SHAP with CUDA support by cloning the shap repo using git clone https://github.com/slundberg/shap.git then running python setup.py install --user.\r\n\r\nHere I test both both ```export CUDA_PATH=/usr``` and ```export CUDA_PATH=/usr/```.\r\n\r\nHowever I cannot complete install it:\r\n\r\nDuring the installation:\r\n```\r\n(ForShap) mike@mike-desktop:~/shap$ python setup.py install --user\r\nNVCC ==>  /usr/bin/nvcc\r\nCompiling cuda extension, calling nvcc with arguments:\r\n['/usr/bin/nvcc', 'shap/cext/_cext_gpu.cu', '-lib', '-o', 'build/lib_cext_gpu.a', '-Xcompiler', '-fPIC', '-I/home/mike/anaconda3/envs/ForShap/include/python3.9', '--std', 'c++14', '--expt-extended-lambda', '--expt-relaxed-constexpr', '-arch=sm_37', '-gencode=arch=compute_37,code=sm_37', '-gencode=arch=compute_70,code=sm_70', '-gencode=arch=compute_75,code=sm_75', '-gencode=arch=compute_75,code=compute_75']\r\nnvcc warning : The 'compute_35', 'compute_37', 'compute_50', 'sm_35', 'sm_37' and 'sm_50' architectures are deprecated, and may be removed in a future release (Use -Wno-deprecated-gpu-targets to suppress warning).\r\n/usr/include/c++/11/bits/std_function.h:435:145: error: parameter packs not expanded with ‘...’:\r\n  435 |         function(_Functor&& __f)\r\n      |                                                                                                                                                 ^ \r\n/usr/include/c++/11/bits/std_function.h:435:145: note:         ‘_ArgTypes’\r\n/usr/include/c++/11/bits/std_function.h:530:146: error: parameter packs not expanded with ‘...’:\r\n  530 |         operator=(_Functor&& __f)\r\n      |                                                                                                                                                  ^ \r\n/usr/include/c++/11/bits/std_function.h:530:146: note:         ‘_ArgTypes’\r\nError building cuda module: CalledProcessError(1, ['/usr/bin/nvcc', 'shap/cext/_cext_gpu.cu', '-lib', '-o', 'build/lib_cext_gpu.a', '-Xcompiler', '-fPIC', '-I/home/mike/anaconda3/envs/ForShap/include/python3.9', '--std', 'c++14', '--expt-extended-lambda', '--expt-relaxed-constexpr', '-arch=sm_37', '-gencode=arch=compute_37,code=sm_37', '-gencode=arch=compute_70,code=sm_70', '-gencode=arch=compute_75,code=sm_75', '-gencode=arch=compute_75,code=compute_75'])\r\nWARNING: Could not compile cuda extensions\r\n......\r\n``` \r\n\r\nThen I run the code to test:\r\n```\r\nimport shap\r\nimport xgboost\r\n\r\n# get a dataset on income prediction\r\nX,y = shap.datasets.adult()\r\n\r\n# train an XGBoost model (but any other model type would also work)\r\nmodel = xgboost.XGBClassifier()\r\nmodel.fit(X, y)\r\n# build a Permutation explainer and explain the model predictions on the given dataset\r\nexplainer = shap.explainers.GPUTree(model, X)\r\n```\r\n\r\nThe first error comes:\r\n```\r\n>>> explainer = shap.explainers.GPUTree(model, X)\r\nC extension was not built during install!\r\nTraceback (most recent call last):\r\n  File \"<stdin>\", line 1, in <module>\r\n  File \"/home/mike/shap/shap/explainers/_tree.py\", line 149, in __init__\r\n    self.model = TreeEnsemble(model, self.data, self.data_missing, model_output)\r\n  File \"/home/mike/shap/shap/explainers/_tree.py\", line 837, in __init__\r\n    self.trees = xgb_loader.get_trees(data=data, data_missing=data_missing)\r\n  File \"/home/mike/shap/shap/explainers/_tree.py\", line 1540, in get_trees\r\n    trees.append(SingleTree({\r\n  File \"/home/mike/shap/shap/explainers/_tree.py\", line 1141, in __init__\r\n    assert_import(\"cext\")\r\n  File \"/home/mike/shap/shap/utils/_general.py\", line 25, in assert_import\r\n    raise e\r\n  File \"/home/mike/shap/shap/explainers/_tree.py\", line 25, in <module>\r\n    from .. import _cext\r\nImportError: cannot import name '_cext' from partially initialized module 'shap' (most likely due to a circular import) (/home/mike/shap/shap/__init__.py)\r\n\r\n```\r\n\r\nThen I check ```conda list```:\r\n```\r\n(ForShap) mike@mike-desktop:~/shap$ conda list\r\n# packages in environment at /home/mike/anaconda3/envs/ForShap:\r\n#\r\n# Name                    Version                   Build  Channel\r\n_libgcc_mutex             0.1                        main  \r\n_openmp_mutex             5.1                       1_gnu  \r\n_py-xgboost-mutex         2.0                       cpu_0  \r\nblas                      1.0                         mkl  \r\nca-certificates           2022.10.11           h06a4308_0  \r\ncertifi                   2022.9.24        py39h06a4308_0  \r\ncloudpickle               2.2.0                    pypi_0    pypi\r\nfftw                      3.3.9                h27cfd23_1  \r\nintel-openmp              2021.4.0          h06a4308_3561  \r\njoblib                    1.2.0                    pypi_0    pypi\r\nld_impl_linux-64          2.38                 h1181459_1  \r\nlibffi                    3.3                  he6710b0_2  \r\nlibgcc-ng                 11.2.0               h1234567_1  \r\nlibgfortran-ng            11.2.0               h00389a5_1  \r\nlibgfortran5              11.2.0               h1234567_1  \r\nlibgomp                   11.2.0               h1234567_1  \r\nlibstdcxx-ng              11.2.0               h1234567_1  \r\nlibxgboost                1.5.0                h6a678d5_2  \r\nllvmlite                  0.39.1                   pypi_0    pypi\r\nmkl                       2021.4.0           h06a4308_640  \r\nmkl-service               2.4.0            py39h7f8727e_0  \r\nmkl_fft                   1.3.1            py39hd3c417c_0  \r\nmkl_random                1.2.2            py39h51133e4_0  \r\nncurses                   6.3                  h5eee18b_3  \r\nnumba                     0.56.4                   pypi_0    pypi\r\nnumpy                     1.23.4           py39h14f4228_0  \r\nnumpy-base                1.23.4           py39h31eccc5_0  \r\nopenssl                   1.1.1s               h7f8727e_0  \r\npackaging                 21.3                     pypi_0    pypi\r\npandas                    1.5.2                    pypi_0    pypi\r\npip                       22.2.2           py39h06a4308_0  \r\npy-xgboost                1.5.0            py39h06a4308_2  \r\npyparsing                 3.0.9                    pypi_0    pypi\r\npython                    3.9.15               haa1d7c7_0  \r\npython-dateutil           2.8.2                    pypi_0    pypi\r\npytz                      2022.6                   pypi_0    pypi\r\nreadline                  8.2                  h5eee18b_0  \r\nscikit-learn              1.1.3                    pypi_0    pypi\r\nscipy                     1.9.3                    pypi_0    pypi\r\nsetuptools                65.5.0           py39h06a4308_0  \r\nsix                       1.16.0                   pypi_0    pypi\r\nslicer                    0.0.7                    pypi_0    pypi\r\nsqlite                    3.40.0               h5082296_0  \r\nthreadpoolctl             3.1.0                    pypi_0    pypi\r\ntk                        8.6.12               h1ccaba5_0  \r\ntqdm                      4.64.1                   pypi_0    pypi\r\ntzdata                    2022f                h04d1e81_0  \r\nwheel                     0.37.1             pyhd3eb1b0_0  \r\nxgboost                   1.5.0            py39h06a4308_2  \r\nxz                        5.2.6                h5eee18b_0  \r\nzlib                      1.2.13               h5eee18b_0  \r\n```\r\nI try to install ```gcc``` to solve, by ```conda install -c conda-forge gcc```.\r\n\r\nThen the error in installation:\r\n```\r\n(ForShap) mike@mike-desktop:~/shap$ python setup.py install --user\r\nNVCC ==>  /usr/bin/nvcc\r\nCompiling cuda extension, calling nvcc with arguments:\r\n['/usr/bin/nvcc', 'shap/cext/_cext_gpu.cu', '-lib', '-o', 'build/lib_cext_gpu.a', '-Xcompiler', '-fPIC', '-I/home/mike/anaconda3/envs/ForShap/include/python3.9', '--std', 'c++14', '--expt-extended-lambda', '--expt-relaxed-constexpr', '-arch=sm_37', '-gencode=arch=compute_37,code=sm_37', '-gencode=arch=compute_70,code=sm_70', '-gencode=arch=compute_75,code=sm_75', '-gencode=arch=compute_75,code=compute_75']\r\nnvcc warning : The 'compute_35', 'compute_37', 'compute_50', 'sm_35', 'sm_37' and 'sm_50' architectures are deprecated, and may be removed in a future release (Use -Wno-deprecated-gpu-targets to suppress warning).\r\ngcc: fatal error: cannot execute 'cc1plus': execvp: No such file or directory\r\ncompilation terminated.\r\nnvcc fatal   : Failed to preprocess host compiler properties.\r\nError building cuda module: CalledProcessError(1, ['/usr/bin/nvcc', 'shap/cext/_cext_gpu.cu', '-lib', '-o', 'build/lib_cext_gpu.a', '-Xcompiler', '-fPIC', '-I/home/mike/anaconda3/envs/ForShap/include/python3.9', '--std', 'c++14', '--expt-extended-lambda', '--expt-relaxed-constexpr', '-arch=sm_37', '-gencode=arch=compute_37,code=sm_37', '-gencode=arch=compute_70,code=sm_70', '-gencode=arch=compute_75,code=sm_75', '-gencode=arch=compute_75,code=compute_75'])\r\nWARNING: Could not compile cuda extensions\r\n......\r\n```\r\n\r\nStill does not work.\r\n\r\nPlease help me! Thank you for reading my long log.\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/shap/shap/issues/2776/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/shap/shap/issues/2776/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
