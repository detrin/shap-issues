{
  "url": "https://api.github.com/repos/shap/shap/issues/2027",
  "repository_url": "https://api.github.com/repos/shap/shap",
  "labels_url": "https://api.github.com/repos/shap/shap/issues/2027/labels{/name}",
  "comments_url": "https://api.github.com/repos/shap/shap/issues/2027/comments",
  "events_url": "https://api.github.com/repos/shap/shap/issues/2027/events",
  "html_url": "https://github.com/shap/shap/issues/2027",
  "id": 912518689,
  "node_id": "MDU6SXNzdWU5MTI1MTg2ODk=",
  "number": 2027,
  "title": "Background dataset is the training set, but shap says it does not use all leaves",
  "user": {
    "login": "samFarrellDay",
    "id": 56970744,
    "node_id": "MDQ6VXNlcjU2OTcwNzQ0",
    "avatar_url": "https://avatars.githubusercontent.com/u/56970744?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/samFarrellDay",
    "html_url": "https://github.com/samFarrellDay",
    "followers_url": "https://api.github.com/users/samFarrellDay/followers",
    "following_url": "https://api.github.com/users/samFarrellDay/following{/other_user}",
    "gists_url": "https://api.github.com/users/samFarrellDay/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/samFarrellDay/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/samFarrellDay/subscriptions",
    "organizations_url": "https://api.github.com/users/samFarrellDay/orgs",
    "repos_url": "https://api.github.com/users/samFarrellDay/repos",
    "events_url": "https://api.github.com/users/samFarrellDay/events{/privacy}",
    "received_events_url": "https://api.github.com/users/samFarrellDay/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2021-06-06T00:16:54Z",
  "updated_at": "2021-06-07T18:55:38Z",
  "closed_at": "2021-06-07T18:55:38Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "I understand the need for the tree_path_dependent pertubation algorithm to use all of the leaves in the model, but I am getting this error:\r\n\r\n`AssertionError: The background dataset you provided does not cover all the leaves in the model, so TreeExplainer cannot run with the feature_perturbation=\"tree_path_dependent\" option! Try providing a larger background dataset, or using feature_perturbation=\"interventional\".`\r\n\r\nwhen I pass the model training data in as the background set. This should be impossible, because that would mean a leaf was grown without any samples during training. Unfortunately I can't provide a reproduceable example. I have managed to discover that running the following:\r\n\r\n```\r\nexplainer = shap.TreeExplainer(\r\n    model=lgbmodel,\r\n    data=training_features,\r\n    feature_perturbation=\"tree_path_dependent\",\r\n    model_output=\"raw\"\r\n)\r\nprint(explainer.model.fully_defined_weighting)\r\n```\r\n\r\nreturns False. However, the following:\r\n\r\n```\r\nmodel = TreeEnsemble(\r\n    model=lgbmodel, \r\n    data=training_features.values, \r\n    data_missing=pd.isna(training_features), \r\n    model_output=\"raw\"\r\n)\r\nprint(model.fully_defined_weighting)\r\n```\r\n\r\nreturns True. I'm at a loss of what could be going on here - as far as I can tell, [this line](https://github.com/slundberg/shap/blob/9411b68e8057a6c6f3621765b89b24d82bee13d4/shap/explainers/_tree.py#L147) defines self.model as a TreeEnsemble. The attribute fully_defined_weighting is never touched after that. Any ideas on what could be going on here? lgbmodel is a lightgbm model created with:\r\n\r\n```\r\nlgbmodel = lgb.train(\r\n    params=lgbpars,\r\n    train_set=dtrain,\r\n    num_boost_round=best_iters,\r\n    verbose_eval=True\r\n)\r\n```\r\n\r\nIf it matters, the lgbpars are:\r\n\r\n```\r\nlgbpars = {\r\n    'objective': 'binary',\r\n    'learning_rate': 0.01,\r\n    'num_leaves': 45,\r\n    'min_sum_hessian_in_leaf': 2698,\r\n    'bagging_fraction': 0.7829,\r\n    'bagging_freq': 1,\r\n    'feature_fraction_bynode': 0.6285,\r\n    'min_gain_to_split': 5.3470,\r\n    'min_data_in_leaf': 1965,\r\n    # 'scale_pos_weight': 1,\r\n    'verbose': -1,\r\n}\r\n```",
  "closed_by": {
    "login": "samFarrellDay",
    "id": 56970744,
    "node_id": "MDQ6VXNlcjU2OTcwNzQ0",
    "avatar_url": "https://avatars.githubusercontent.com/u/56970744?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/samFarrellDay",
    "html_url": "https://github.com/samFarrellDay",
    "followers_url": "https://api.github.com/users/samFarrellDay/followers",
    "following_url": "https://api.github.com/users/samFarrellDay/following{/other_user}",
    "gists_url": "https://api.github.com/users/samFarrellDay/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/samFarrellDay/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/samFarrellDay/subscriptions",
    "organizations_url": "https://api.github.com/users/samFarrellDay/orgs",
    "repos_url": "https://api.github.com/users/samFarrellDay/repos",
    "events_url": "https://api.github.com/users/samFarrellDay/events{/privacy}",
    "received_events_url": "https://api.github.com/users/samFarrellDay/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/shap/shap/issues/2027/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/shap/shap/issues/2027/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
