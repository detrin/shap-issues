{
  "url": "https://api.github.com/repos/shap/shap/issues/2644",
  "repository_url": "https://api.github.com/repos/shap/shap",
  "labels_url": "https://api.github.com/repos/shap/shap/issues/2644/labels{/name}",
  "comments_url": "https://api.github.com/repos/shap/shap/issues/2644/comments",
  "events_url": "https://api.github.com/repos/shap/shap/issues/2644/events",
  "html_url": "https://github.com/shap/shap/issues/2644",
  "id": 1331038541,
  "node_id": "I_kwDOBHDcK85PVglN",
  "number": 2644,
  "title": "Poor performance of TreeExplainer for shap version >=0.36",
  "user": {
    "login": "Piecer-plc",
    "id": 109329809,
    "node_id": "U_kgDOBoQ9kQ",
    "avatar_url": "https://avatars.githubusercontent.com/u/109329809?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Piecer-plc",
    "html_url": "https://github.com/Piecer-plc",
    "followers_url": "https://api.github.com/users/Piecer-plc/followers",
    "following_url": "https://api.github.com/users/Piecer-plc/following{/other_user}",
    "gists_url": "https://api.github.com/users/Piecer-plc/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Piecer-plc/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Piecer-plc/subscriptions",
    "organizations_url": "https://api.github.com/users/Piecer-plc/orgs",
    "repos_url": "https://api.github.com/users/Piecer-plc/repos",
    "events_url": "https://api.github.com/users/Piecer-plc/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Piecer-plc/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 0,
  "created_at": "2022-08-07T14:51:44Z",
  "updated_at": "2022-08-07T14:51:44Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "Hi. I used TreeExplainer in my program but I noticed that its memory increased when adopting higher versions of shap.\r\n\r\nAs shown in the following experiment results, this model performs best if we use shap<=0.34.\r\n\r\nMy question is that why does such a library version perform better? Are there any issues in newer versions?\r\n\r\nThe detailed information is as follows:\r\n|Memory|Version|\r\n|--|--|\r\n|69MB|0.40|\r\n| 69MB|0.39 |\r\n| 69MB|0.38.1 |\r\n|68MB | 0.36|\r\n| 53MB| 0.34|\r\n\r\n### Steps/Code to Reproduce\r\n[test.csv](https://github.com/slundberg/shap/files/9276978/test.csv)\r\n[train.csv](https://github.com/slundberg/shap/files/9276980/train.csv)\r\n```python\r\nimport numpy as np # linear algebra\r\nimport pandas as pd # data processing, CSV file I/O (e.g. pd.read_csv)\r\nimport time\r\nstart_time = time.time()\r\ndf_train = pd.read_csv('train.csv')\r\ndf_train = df_train.drop('id', axis = 1)\r\ndf_ot3 = df_train.quantile(0.95)\r\ndf_ot4 = df_train > (df_ot3*1.5)\r\nfrom sklearn.preprocessing import MinMaxScaler, LabelEncoder\r\nX = df_train.iloc[:, :-1]\r\ny = df_train.iloc[:, -1]\r\nLenc = LabelEncoder()\r\nLenc.fit(y)\r\ny = Lenc.transform(y)\r\nmnmx_scl = MinMaxScaler()\r\nmnmx_scl.fit(X)\r\nX = mnmx_scl.transform(X)\r\nX_df = pd.DataFrame(X)\r\nfrom sklearn.model_selection import train_test_split\r\nX_train, X_test, y_train, y_test = train_test_split(X_df, y, test_size = 0.4, stratify = y)\r\nfrom xgboost import XGBClassifier\r\nxgb_clf = XGBClassifier(learning_rate = 0.1, n_estimators = 200,use_label_encoder = False, verbose= None, objective = 'multi:softmax', eval_metric = 'mlogloss',eval_set = [X_test, y_test])\r\nxgb_clf.fit(X_train, y_train)\r\ny_pred_xgb_pr = xgb_clf.predict_proba(X_test)\r\nimport tracemalloc\r\ntracemalloc.start()\r\n# 0.34 63MB\r\nimport shap\r\nexplainer = shap.TreeExplainer(xgb_clf)\r\nshap_values = explainer.shap_values(X_test)\r\ncurrent3, peak3 = tracemalloc.get_traced_memory()\r\nprint(\"Get_dummies memory usage is {\",current3 /1024/1024,\"}MB; Peak memory was :{\",peak3 / 1024/1024,\"}MB\")\r\n#0.40 69\r\n#0.34 53\r\n```",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/shap/shap/issues/2644/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/shap/shap/issues/2644/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
