{
  "url": "https://api.github.com/repos/shap/shap/issues/2710",
  "repository_url": "https://api.github.com/repos/shap/shap",
  "labels_url": "https://api.github.com/repos/shap/shap/issues/2710/labels{/name}",
  "comments_url": "https://api.github.com/repos/shap/shap/issues/2710/comments",
  "events_url": "https://api.github.com/repos/shap/shap/issues/2710/events",
  "html_url": "https://github.com/shap/shap/pull/2710",
  "id": 1392142286,
  "node_id": "PR_kwDOBHDcK84_7ECU",
  "number": 2710,
  "title": "[Bugfix] Fix TypeError at force_plot: can only concatenate str (not float) to str",
  "user": {
    "login": "myui",
    "id": 1163783,
    "node_id": "MDQ6VXNlcjExNjM3ODM=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1163783?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/myui",
    "html_url": "https://github.com/myui",
    "followers_url": "https://api.github.com/users/myui/followers",
    "following_url": "https://api.github.com/users/myui/following{/other_user}",
    "gists_url": "https://api.github.com/users/myui/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/myui/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/myui/subscriptions",
    "organizations_url": "https://api.github.com/users/myui/orgs",
    "repos_url": "https://api.github.com/users/myui/repos",
    "events_url": "https://api.github.com/users/myui/events{/privacy}",
    "received_events_url": "https://api.github.com/users/myui/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 0,
  "created_at": "2022-09-30T09:25:43Z",
  "updated_at": "2023-06-13T08:06:08Z",
  "closed_at": "2023-06-13T08:06:07Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/shap/shap/pulls/2710",
    "html_url": "https://github.com/shap/shap/pull/2710",
    "diff_url": "https://github.com/shap/shap/pull/2710.diff",
    "patch_url": "https://github.com/shap/shap/pull/2710.patch",
    "merged_at": null
  },
  "body": "We got the following TypeError for force_plot at [this line](https://github.com/slundberg/shap/blob/v0.41.0/shap/plots/_force_matplotlib.py#L117) `' = ' + feature[1]`.\r\n\r\nfeature[1] comes from https://github.com/slundberg/shap/blob/v0.41.0/shap/plots/_force_matplotlib.py#L210\r\nit comes from https://github.com/slundberg/shap/blob/510c4b6a85e4189573ef8290392139586c4292f5/shap/plots/_force.py#L401\r\nand can be non-str object\r\nhttps://github.com/slundberg/shap/blob/510c4b6a85e4189573ef8290392139586c4292f5/shap/plots/_force.py#L308\r\n\r\nThis PR converts non-str object at feature[1] to str to fix TypeError at string concatenation.\r\n\r\n```\r\nTypeError                                 Traceback (most recent call last)\r\nInput In [85], in <cell line: 4>()\r\n      5 display(pd.DataFrame(X.iloc[rowid]))\r\n      6 try:\r\n----> 7     shap.force_plot(\r\n      8         base_value=expected_value1, \r\n      9         shap_values=shap_value1[rowid],\r\n     10         features=X.iloc[rowid],\r\n     11         feature_names=X.columns,\r\n     12         # link='logit',\r\n     13         matplotlib=True\r\n     14     )\r\n     15     waterfall(shap_obj[rowid], feature_names=X.columns)\r\n     16 except ValueError as e:\r\n     17     # 1. avoid shap library bug for ValueError: Image size of xxx pixels is too large. It must be less than 2^16 in each direction. \r\nFile /usr/local/lib/python3.8/site-packages/shap/plots/_force.py:164, in force(base_value, shap_values, features, feature_names, out_names, link, plot_cmap, matplotlib, show, figsize, ordering_keys, ordering_keys_time_format, text_rotation, contribution_threshold)\r\n    152     instance = Instance(np.zeros((1, len(feature_names))), features)\r\n    153     e = AdditiveExplanation(\r\n    154         base_value,\r\n    155         np.sum(shap_values[0, :]) + base_value,\r\n   (...)\r\n    161         DenseData(np.zeros((1, len(feature_names))), list(feature_names))\r\n    162     )\r\n--> 164     return visualize(e,\r\n    165                      plot_cmap,\r\n    166                      matplotlib,\r\n    167                      figsize=figsize,\r\n    168                      show=show,\r\n    169                      text_rotation=text_rotation,\r\n    170                      min_perc=contribution_threshold)\r\n    172 else:\r\n    173     if matplotlib:\r\nFile /usr/local/lib/python3.8/site-packages/shap/plots/_force.py:334, in visualize(e, plot_cmap, matplotlib, figsize, show, ordering_keys, ordering_keys_time_format, text_rotation, min_perc)\r\n    332 if isinstance(e, AdditiveExplanation):\r\n    333     if matplotlib:\r\n--> 334         return AdditiveForceVisualizer(e, plot_cmap=plot_cmap).matplotlib(figsize=figsize,\r\n    335                                                                 show=show,\r\n    336                                                                 text_rotation=text_rotation,\r\n    337                                                                 min_perc=min_perc)\r\n    338     else:\r\n    339         return AdditiveForceVisualizer(e, plot_cmap=plot_cmap)\r\nFile /usr/local/lib/python3.8/site-packages/shap/plots/_force.py:426, in AdditiveForceVisualizer.matplotlib(self, figsize, show, text_rotation, min_perc)\r\n    425 def matplotlib(self, figsize, show, text_rotation, min_perc=0.05):\r\n--> 426     fig = draw_additive_plot(self.data,\r\n    427                              figsize=figsize,\r\n    428                              show=show,\r\n    429                              text_rotation=text_rotation,\r\n    430                              min_perc=min_perc)\r\n    432     return fig\r\nFile /usr/local/lib/python3.8/site-packages/shap/plots/_force_matplotlib.py:385, in draw_additive_plot(data, figsize, show, text_rotation, min_perc)\r\n    383 # Add labels\r\n    384 total_effect = np.abs(total_neg) + total_pos\r\n--> 385 fig, ax = draw_labels(fig, ax, out_value, neg_features, 'negative',\r\n    386                       offset_text, total_effect, min_perc=min_perc, text_rotation=text_rotation)\r\n    388 fig, ax = draw_labels(fig, ax, out_value, pos_features, 'positive',\r\n    389                       offset_text, total_effect, min_perc=min_perc, text_rotation=text_rotation)\r\n    391 # higher lower legend\r\nFile /usr/local/lib/python3.8/site-packages/shap/plots/_force_matplotlib.py:117, in draw_labels(fig, ax, out_value, features, feature_type, offset_text, total_effect, min_perc, text_rotation)\r\n    115     text = feature[2]\r\n    116 else:\r\n--> 117     text = feature[2] + ' = ' + feature[1]\r\n    119 if text_rotation is not 0:\r\n    120     va_alignment = 'top'\r\nTypeError: can only concatenate str (not \"float\") to str\r\n```",
  "closed_by": {
    "login": "myui",
    "id": 1163783,
    "node_id": "MDQ6VXNlcjExNjM3ODM=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1163783?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/myui",
    "html_url": "https://github.com/myui",
    "followers_url": "https://api.github.com/users/myui/followers",
    "following_url": "https://api.github.com/users/myui/following{/other_user}",
    "gists_url": "https://api.github.com/users/myui/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/myui/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/myui/subscriptions",
    "organizations_url": "https://api.github.com/users/myui/orgs",
    "repos_url": "https://api.github.com/users/myui/repos",
    "events_url": "https://api.github.com/users/myui/events{/privacy}",
    "received_events_url": "https://api.github.com/users/myui/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/shap/shap/issues/2710/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/shap/shap/issues/2710/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
