{
  "url": "https://api.github.com/repos/shap/shap/issues/1978",
  "repository_url": "https://api.github.com/repos/shap/shap",
  "labels_url": "https://api.github.com/repos/shap/shap/issues/1978/labels{/name}",
  "comments_url": "https://api.github.com/repos/shap/shap/issues/1978/comments",
  "events_url": "https://api.github.com/repos/shap/shap/issues/1978/events",
  "html_url": "https://github.com/shap/shap/issues/1978",
  "id": 876613882,
  "node_id": "MDU6SXNzdWU4NzY2MTM4ODI=",
  "number": 1978,
  "title": "SHAP plots fail for sklearn's Isolation Forest",
  "user": {
    "login": "wundermahn",
    "id": 25335672,
    "node_id": "MDQ6VXNlcjI1MzM1Njcy",
    "avatar_url": "https://avatars.githubusercontent.com/u/25335672?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/wundermahn",
    "html_url": "https://github.com/wundermahn",
    "followers_url": "https://api.github.com/users/wundermahn/followers",
    "following_url": "https://api.github.com/users/wundermahn/following{/other_user}",
    "gists_url": "https://api.github.com/users/wundermahn/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/wundermahn/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/wundermahn/subscriptions",
    "organizations_url": "https://api.github.com/users/wundermahn/orgs",
    "repos_url": "https://api.github.com/users/wundermahn/repos",
    "events_url": "https://api.github.com/users/wundermahn/events{/privacy}",
    "received_events_url": "https://api.github.com/users/wundermahn/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2021-05-05T16:07:53Z",
  "updated_at": "2022-09-21T15:41:55Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "I'm trying to use [sklearn's Isolation Forest ](https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.IsolationForest.html) to create an anomaly detection model. I want to also see the SHAP values for my model.\r\n\r\nI am currently able to do so using the method discussed in Issue #1152. I can then use `summary_plot` to create either bar charts, or the dot charts. However, I want to be able to use `beeswarm` and others to observe the different shap values for the different \"classes\" (aka anomalous, not anomalous).\r\n\r\nFor example, this works fine:\r\n```\r\n# Isolation Forest Shap Values\r\nisof_f = lambda x: isof.decision_function(x)\r\nisof_explainer = shap.KernelExplainer(isof_f, shap.sample(X_te, 100))\r\nisof_shap = isof_explainer.shap_values(X_te[:50])\r\n\r\n# Change feature names to obscure for Github posting\r\nshap.summary_plot(isof_shap, \r\n                  feature_names=['feature_{}'.format(i) for i in range(len(X_te.columns))], \r\n                  class_names=['Anomaly', 'Normal'], \r\n                  show=True, plot_type='dot')\r\n\r\n```\r\n![image](https://user-images.githubusercontent.com/25335672/117172124-818c7700-ad99-11eb-9eae-1e1cb92567fe.png)\r\n\r\nHowever, I'm unable to use **anything** from `shap.plots`. See below:\r\n`shap.plots.beeswarm(isof_shap, max_display=10, plot_size='auto')`\r\n\r\nYields:\r\n---------------------------------------------------------------------------\r\n\r\n> UnboundLocalError                         Traceback (most recent call last)\r\n> <ipython-input-31-8c3d362c900a> in <module>\r\n> ----> 1 shap.plots.beeswarm(isof_shap, max_display=10, plot_size='auto')\r\n> \r\n> c:\\users\\wundermahn\\appdata\\local\\programs\\python\\python38\\lib\\site-packages\\shap\\plots\\_beeswarm.py in beeswarm(shap_values, max_display, order, clustering, cluster_threshold, color, axis_color, alpha, show, log_scale, color_bar, plot_size, color_bar_label)\r\n>      65         #     out_names = shap_exp.output_names\r\n>      66 \r\n> ---> 67     order = convert_ordering(order, values)\r\n>      68 \r\n>      69 \r\n> \r\n> UnboundLocalError: local variable 'values' referenced before assignment\r\n\r\nIssue #1586 points us to Issue #1460 to [try and use a technique](https://github.com/slundberg/shap/issues/1460#issuecomment-770317209) to get the SHAP object, but even that fails. See below:\r\n\r\n```\r\n# Isolation Forest Shap Values\r\nisof_f = lambda x: isof.decision_function(x)\r\nisof_explainer = shap.KernelExplainer(isof_f, shap.sample(X_te, 100))\r\nexplainer_obj = isof_explainer(X_te[:50])\r\nisof_shap = isof_explainer.shap_values(X_te[:50])\r\n```\r\n\r\nYields:\r\n\r\n> ---------------------------------------------------------------------------\r\n> AttributeError                            Traceback (most recent call last)\r\n> <ipython-input-42-7bfda8b35a63> in <module>\r\n>       2 isof_f = lambda x: isof.decision_function(x)\r\n>       3 isof_explainer = shap.KernelExplainer(isof_f, shap.sample(X_te, 100))\r\n> ----> 4 explainer_obj = isof_explainer(X_te[:50])\r\n>       5 isof_shap = isof_explainer.shap_values(X_te[:50])\r\n> \r\n> c:\\users\\wundermahn\\appdata\\local\\programs\\python\\python38\\lib\\site-packages\\shap\\explainers\\_explainer.py in __call__(self, max_evals, main_effects, error_bounds, batch_size, outputs, silent, *args, **kwargs)\r\n>     203         #     self._brute_force_fallback\r\n>     204 \r\n> --> 205         if issubclass(type(self.masker), maskers.OutputComposite) and len(args)==2:\r\n>     206             self.masker.model = models.TextGeneration(target_sentences=args[1])\r\n>     207             args = args[:1]\r\n> \r\n> AttributeError: 'Kernel' object has no attribute 'masker'\r\n\r\nHow can we use `shap.plots` with Isolation Forest? It seems like we are unable to do so with `KernelExplainer`, but running `TreeExplainer` with Isolation Forests yields \r\n\r\n> Exception: Model type not yet supported by TreeExplainer: <class 'function'>\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/shap/shap/issues/1978/reactions",
    "total_count": 6,
    "+1": 6,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/shap/shap/issues/1978/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
