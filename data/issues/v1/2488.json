{
  "url": "https://api.github.com/repos/shap/shap/issues/2488",
  "repository_url": "https://api.github.com/repos/shap/shap",
  "labels_url": "https://api.github.com/repos/shap/shap/issues/2488/labels{/name}",
  "comments_url": "https://api.github.com/repos/shap/shap/issues/2488/comments",
  "events_url": "https://api.github.com/repos/shap/shap/issues/2488/events",
  "html_url": "https://github.com/shap/shap/issues/2488",
  "id": 1196820430,
  "node_id": "I_kwDOBHDcK85HVgfO",
  "number": 2488,
  "title": "Explainer produces output_names with incorrect shape seemingly randomly",
  "user": {
    "login": "trzy",
    "id": 1285573,
    "node_id": "MDQ6VXNlcjEyODU1NzM=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1285573?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/trzy",
    "html_url": "https://github.com/trzy",
    "followers_url": "https://api.github.com/users/trzy/followers",
    "following_url": "https://api.github.com/users/trzy/following{/other_user}",
    "gists_url": "https://api.github.com/users/trzy/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/trzy/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/trzy/subscriptions",
    "organizations_url": "https://api.github.com/users/trzy/orgs",
    "repos_url": "https://api.github.com/users/trzy/repos",
    "events_url": "https://api.github.com/users/trzy/events{/privacy}",
    "received_events_url": "https://api.github.com/users/trzy/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 0,
  "created_at": "2022-04-08T04:38:50Z",
  "updated_at": "2022-04-08T04:38:50Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "I am hitting this assertion frequently:\r\n\r\n```\r\n  File \"C:\\Users\\Bart\\anaconda3\\envs\\avatarize\\lib\\site-packages\\shap\\plots\\_image.py\", line 84, in image\r\n    assert labels.shape[0] == shap_values[0].shape[0], \"Labels must have same row count as shap_values arrays!\"\r\nAssertionError: Labels must have same row count as shap_values arrays!\r\n```\r\n\r\nBut sometimes, I don't! I'm running the same bit of code over and over again. I'm feeding two images (2x224x224x3) into the explainer and my class_names array contains all label names  for class indices 0-4 (I am trying to analyze an image classifier with 5 output classes).\r\n\r\nApparently, what is happening is that sometimes, shap_values.output_names contains just a 1D list, e.g.: ['none', 'bangs_front', 'right', 'left', 'split']\r\n\r\nThe only thing that changes between different runs is that I input a different pair of images (because my dataset iterator shuffles the data). However, it is always a pair of images that are fed in. Why is this producing such wildly differing results?\r\n\r\nHere is my code:\r\n\r\n```\r\ndef test_shap():\r\n  import shap\r\n  data = multilabel_dataset.Dataset(\r\n    attribute = \"hair_part\",\r\n    src_dir = \"facedata\",\r\n    split = \"train\",\r\n    batch_size = 2,\r\n    crop = crop())\r\n  class_names = [ data.class_name_by_index[i] for i in range(data.num_classes) ]\r\n  it = iter(data.dataset)\r\n  X = next(it)[0].numpy() # just the images (x values), as numpy arrays. Here X is always of shape (2,224,224,3)\r\n  model = TrainingModel(\r\n    num_classes = data.num_classes,\r\n    top_k = options.top_k,\r\n    learning_rate = options.learning_rate,\r\n    momentum = options.momentum,\r\n    dropout = options.dropout,\r\n    l2 = options.l2,\r\n    freeze_layers = options.freeze\r\n  )\r\n  model.load_weights(filepath = \"hair_part_left.h5\", by_name = True)\r\n  def f(x):\r\n    y=model.predict(x)\r\n    return y\r\n  masker = shap.maskers.Image(\"inpaint_telea\", X[0].shape)\r\n  explainer = shap.Explainer(f, masker, output_names=class_names)\r\n  shap_values = explainer(X[0:2], max_evals=300, batch_size=50, outputs=shap.Explanation.argsort.flip[:5])\r\n  shap.image_plot(shap_values)\r\n```",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/shap/shap/issues/2488/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/shap/shap/issues/2488/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
