{
  "url": "https://api.github.com/repos/shap/shap/issues/380",
  "repository_url": "https://api.github.com/repos/shap/shap",
  "labels_url": "https://api.github.com/repos/shap/shap/issues/380/labels{/name}",
  "comments_url": "https://api.github.com/repos/shap/shap/issues/380/comments",
  "events_url": "https://api.github.com/repos/shap/shap/issues/380/events",
  "html_url": "https://github.com/shap/shap/issues/380",
  "id": 396088738,
  "node_id": "MDU6SXNzdWUzOTYwODg3Mzg=",
  "number": 380,
  "title": "Do shap values from model_output=logloss sum exactly to logloss?",
  "user": {
    "login": "jphall663",
    "id": 5297912,
    "node_id": "MDQ6VXNlcjUyOTc5MTI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5297912?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jphall663",
    "html_url": "https://github.com/jphall663",
    "followers_url": "https://api.github.com/users/jphall663/followers",
    "following_url": "https://api.github.com/users/jphall663/following{/other_user}",
    "gists_url": "https://api.github.com/users/jphall663/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jphall663/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jphall663/subscriptions",
    "organizations_url": "https://api.github.com/users/jphall663/orgs",
    "repos_url": "https://api.github.com/users/jphall663/repos",
    "events_url": "https://api.github.com/users/jphall663/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jphall663/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 486901330,
      "node_id": "MDU6TGFiZWw0ODY5MDEzMzA=",
      "url": "https://api.github.com/repos/shap/shap/labels/todo",
      "name": "todo",
      "color": "cccccc",
      "default": false,
      "description": "This issue had an outstanding action to take."
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 8,
  "created_at": "2019-01-04T22:28:11Z",
  "updated_at": "2019-01-24T00:21:32Z",
  "closed_at": "2019-01-23T18:38:03Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "Using:\r\n\r\n`explainer = shap.TreeExplainer(xgb_model, test_yhat[X], feature_dependence='independent', model_output='logloss')` \r\n\r\nI am able to calculate shap contributions to the logloss (or something like that) for each row, but I am unable to work out how these shap values sum to the logloss *exactly*. Maybe they are not supposed to be exact? Maybe I am doing something dumb?\r\n\r\n*** \r\n\r\nHere is the setup: \r\n\r\nubuntu v. 16.04\r\npython v. 3.6.4\r\nshap v. 0.26.0\r\nxgboost v. 0.7\r\n\r\nFor a given row, the label, prediction, and logloss (calculated by me) is:\r\n\r\ny | p_DEFAULT_NEXT_MONTH | r_DEFAULT_NEXT_MONTH\r\n-- | -- | --\r\n1 | 0.028777 | 3.548167\r\n\r\nI calculate logloss with: \r\n\r\n`test_yhat['r_DEFAULT_NEXT_MONTH'] = -test_yhat[y]*np.log(test_yhat['p_DEFAULT_NEXT_MONTH']) -\\\r\n                                     (1 - test_yhat[y])*np.log(1 - test_yhat['p_DEFAULT_NEXT_MONTH'])`\r\n\r\nThe Shapley contributions to logloss for the inputs are:\r\n\r\nInput | Contrib\r\n--|--\r\nPAY_AMT2   |  0.444923\r\nPAY_3      |  0.372438\r\nPAY_0     |   0.311950\r\nPAY_AMT3  |   0.275476\r\nPAY_2    |    0.217491\r\nPAY_AMT1   |  0.182761\r\nPAY_6     |   0.166236\r\nLIMIT_BAL  |  0.141369\r\nPAY_5    |    0.139306\r\nPAY_AMT5   |  0.135913\r\nBILL_AMT1  |  0.115837\r\nPAY_AMT4   |  0.086789\r\nMARRIAGE  |   0.086296\r\nPAY_4    |    0.064933\r\nBILL_AMT5  |  0.045914\r\nAGE    |      0.038773\r\nBILL_AMT2  |  0.032538\r\nPAY_AMT6   |  0.030993\r\nBILL_AMT4  |  0.024876\r\nBILL_AMT6  |  0.009982\r\nBILL_AMT3  | -0.009435\r\nEDUCATION  |  -0.033935\r\nSEX    |     -0.074084\r\n\r\nThe sum of these is: `2.8073386454201277`\r\n\r\n`explainer.expected_value` is `0.319597019754289`\r\n\r\n*** \r\n\r\nI'm not seeing how to combine `2.8073386454201277` and `0.319597019754289` to make `3.548167` ... any assistance would be greatly appreciated!\r\n",
  "closed_by": {
    "login": "jphall663",
    "id": 5297912,
    "node_id": "MDQ6VXNlcjUyOTc5MTI=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5297912?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jphall663",
    "html_url": "https://github.com/jphall663",
    "followers_url": "https://api.github.com/users/jphall663/followers",
    "following_url": "https://api.github.com/users/jphall663/following{/other_user}",
    "gists_url": "https://api.github.com/users/jphall663/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jphall663/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jphall663/subscriptions",
    "organizations_url": "https://api.github.com/users/jphall663/orgs",
    "repos_url": "https://api.github.com/users/jphall663/repos",
    "events_url": "https://api.github.com/users/jphall663/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jphall663/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/shap/shap/issues/380/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/shap/shap/issues/380/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
