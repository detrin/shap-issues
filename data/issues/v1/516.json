{
  "url": "https://api.github.com/repos/shap/shap/issues/516",
  "repository_url": "https://api.github.com/repos/shap/shap",
  "labels_url": "https://api.github.com/repos/shap/shap/issues/516/labels{/name}",
  "comments_url": "https://api.github.com/repos/shap/shap/issues/516/comments",
  "events_url": "https://api.github.com/repos/shap/shap/issues/516/events",
  "html_url": "https://github.com/shap/shap/pull/516",
  "id": 425673047,
  "node_id": "MDExOlB1bGxSZXF1ZXN0MjY0NzEzOTk3",
  "number": 516,
  "title": "Fix maxpool1d in pytorch deep explainer",
  "user": {
    "login": "gabrieltseng",
    "id": 29063740,
    "node_id": "MDQ6VXNlcjI5MDYzNzQw",
    "avatar_url": "https://avatars.githubusercontent.com/u/29063740?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/gabrieltseng",
    "html_url": "https://github.com/gabrieltseng",
    "followers_url": "https://api.github.com/users/gabrieltseng/followers",
    "following_url": "https://api.github.com/users/gabrieltseng/following{/other_user}",
    "gists_url": "https://api.github.com/users/gabrieltseng/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/gabrieltseng/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gabrieltseng/subscriptions",
    "organizations_url": "https://api.github.com/users/gabrieltseng/orgs",
    "repos_url": "https://api.github.com/users/gabrieltseng/repos",
    "events_url": "https://api.github.com/users/gabrieltseng/events{/privacy}",
    "received_events_url": "https://api.github.com/users/gabrieltseng/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 8,
  "created_at": "2019-03-26T22:14:36Z",
  "updated_at": "2019-08-07T13:25:33Z",
  "closed_at": "2019-04-18T00:09:20Z",
  "author_association": "COLLABORATOR",
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/shap/shap/pulls/516",
    "html_url": "https://github.com/shap/shap/pull/516",
    "diff_url": "https://github.com/shap/shap/pull/516.diff",
    "patch_url": "https://github.com/shap/shap/pull/516.patch",
    "merged_at": "2019-04-18T00:09:20Z"
  },
  "body": "This is a partial fix to the issue raised in https://github.com/slundberg/shap/issues/477 .\r\n\r\nThe problem is that the MaxPool1d module doesn't have the same behavior as other modules when a backward hook is added. Specifically, a backward hook receives (as arguments) a `grad_input`, which is the gradient of the inputs, and `grad_output`, which is the gradient of the outputs. `grad_input` is the same shape as the input, and `grad_output` is the same shape as the output, as can be seen for this example with MaxPool2d:\r\n\r\n```python\r\n>>> import torch\r\n>>> from torch import nn\r\n>>> test_2d_input = torch.ones(40, 10, 10, 13, requires_grad=True)\r\n>>> test_2d_output = torch.ones(40, 10, 5, 6, requires_grad=True)\r\n>>> maxpool2d = nn.MaxPool2d(kernel_size=2)\r\n>>> def print_grads(module, grad_input, grad_output):\r\n...     print(module)\r\n...     print([g.shape for g in grad_input])\r\n...     print([g.shape for g in grad_output])\r\n...\r\n>>> maxpool2d.register_backward_hook(print_grads)\r\n<torch.utils.hooks.RemovableHandle object at 0x109059860>\r\n>>> o_2d = maxpool2d(test_2d_input)\r\n>>> o_2d.backward(test_2d_output)\r\nMaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)\r\n[torch.Size([40, 10, 10, 13])]\r\n[torch.Size([40, 10, 5, 6])]\r\n```\r\n\r\nFor maxpool1d, `grad_input` actually only contains the gradients for the \"selected\" inputs (i.e. the maximum of a kernel), which explains the following behaviour, where `grad_input` and `grad_output` have the same number of elements.\r\n```python\r\n>>> test_1d_input = torch.ones(40, 1, 13, requires_grad=True)\r\n>>> test_1d_output = torch.ones(40, 1, 6, requires_grad=True)\r\n>>> maxpool1d = nn.MaxPool1d(kernel_size=2)\r\n>>> def print_grads(module, grad_input, grad_output):\r\n...     print(module)\r\n...     print([g.shape for g in grad_input])\r\n...     print([g.shape for g in grad_output])\r\n...\r\n>>> maxpool1d.register_backward_hook(print_grads)\r\n<torch.utils.hooks.RemovableHandle at 0x11c505ef0>\r\n>>> o_1d = maxpool1d(test_1d_input)\r\n>>> o_1d.backward(test_1d_output)\r\nMaxPool1d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)\r\n[torch.Size([40, 1, 1, 6])]\r\n[torch.Size([40, 1, 6])]\r\n```\r\nI have fixed the bug so that the output is the right shape, but there is now an issue where if the deep explainer assigned a non-zero gradient to an element which was not selected in the maxpooling layer, there is no way for that gradient to be propagated back, meaning the shap values will be wrong.\r\n\r\n@slundberg , for now I have added a warning that is printed when a maxpool1d layer is encountered. We could throw an error instead; let me know which you prefer.\r\n\r\nThanks!",
  "closed_by": {
    "login": "slundberg",
    "id": 3740613,
    "node_id": "MDQ6VXNlcjM3NDA2MTM=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3740613?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/slundberg",
    "html_url": "https://github.com/slundberg",
    "followers_url": "https://api.github.com/users/slundberg/followers",
    "following_url": "https://api.github.com/users/slundberg/following{/other_user}",
    "gists_url": "https://api.github.com/users/slundberg/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/slundberg/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/slundberg/subscriptions",
    "organizations_url": "https://api.github.com/users/slundberg/orgs",
    "repos_url": "https://api.github.com/users/slundberg/repos",
    "events_url": "https://api.github.com/users/slundberg/events{/privacy}",
    "received_events_url": "https://api.github.com/users/slundberg/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/shap/shap/issues/516/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/shap/shap/issues/516/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
