{
  "url": "https://api.github.com/repos/shap/shap/issues/966",
  "repository_url": "https://api.github.com/repos/shap/shap",
  "labels_url": "https://api.github.com/repos/shap/shap/issues/966/labels{/name}",
  "comments_url": "https://api.github.com/repos/shap/shap/issues/966/comments",
  "events_url": "https://api.github.com/repos/shap/shap/issues/966/events",
  "html_url": "https://github.com/shap/shap/issues/966",
  "id": 541056352,
  "node_id": "MDU6SXNzdWU1NDEwNTYzNTI=",
  "number": 966,
  "title": "Unable to manually calculate expected value for CatBoostClassifier",
  "user": {
    "login": "Stuart-D-King",
    "id": 19353261,
    "node_id": "MDQ6VXNlcjE5MzUzMjYx",
    "avatar_url": "https://avatars.githubusercontent.com/u/19353261?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Stuart-D-King",
    "html_url": "https://github.com/Stuart-D-King",
    "followers_url": "https://api.github.com/users/Stuart-D-King/followers",
    "following_url": "https://api.github.com/users/Stuart-D-King/following{/other_user}",
    "gists_url": "https://api.github.com/users/Stuart-D-King/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Stuart-D-King/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Stuart-D-King/subscriptions",
    "organizations_url": "https://api.github.com/users/Stuart-D-King/orgs",
    "repos_url": "https://api.github.com/users/Stuart-D-King/repos",
    "events_url": "https://api.github.com/users/Stuart-D-King/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Stuart-D-King/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2019-12-20T15:39:17Z",
  "updated_at": "2020-01-08T15:02:14Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "I seem to be having a hard time manually calculating the base (expected) value from a fitted CatBoostClassifier object. Can someone help me understand why the below code returns two different values for the base value? The exception block is used because calling `shap.TreeExplainer(model)` returns a `    TypeError: object of type 'NoneType' has no len()` error. This is tied to case #757. Thanks for the help.\r\n```python\r\n# Python 3.6.8\r\n\r\nimport catboost\r\nfrom catboost import CatBoostClassifier, Pool\r\nfrom catboost.datasets import titanic\r\nfrom sklearn.model_selection import train_test_split\r\nimport numpy as np\r\nimport shap\r\n\r\nprint(shap.__version__) # 0.33.0\r\nprint(catboost.__version__) # 0.20.1\r\n\r\ntrain_df, test_df = titanic()\r\ntrain_df.fillna(-999, inplace=True)\r\ntest_df.fillna(-999, inplace=True)\r\n\r\nX = train_df.drop('Survived', axis=1)\r\ny = train_df.Survived\r\n\r\ncategorical_features_indices = np.where(X.dtypes != np.float)[0]\r\n\r\nX_train, X_validation, y_train, y_validation = train_test_split(X, y, train_size=0.75, random_state=42)\r\nX_test = test_df\r\n\r\nparams = {\r\n    'iterations': 500,\r\n    'learning_rate': 0.1,\r\n    'eval_metric': 'Accuracy',\r\n    'random_seed': 42,\r\n    'logging_level': 'Silent',\r\n}\r\n\r\ntrain_pool = Pool(X_train, y_train, cat_features=categorical_features_indices)\r\nvalidate_pool = Pool(X_validation, y_validation, cat_features=categorical_features_indices)\r\n\r\nmodel = CatBoostClassifier(**params)\r\nmodel.fit(train_pool, eval_set=validate_pool)\r\n\r\nprint(model.predict(train_pool, prediction_type='RawFormulaVal').mean().round(4))\r\n# -0.7318\r\n\r\ntry:\r\n    # TypeError: object of type 'NoneType' has no len()\r\n    explainer = shap.TreeExplainer(model)\r\n    print(explainer.expected_value.round(4))\r\nexcept:\r\n    print('Exception!')\r\n    shap_values = model.get_feature_importance(train_pool, type=\"ShapValues\")\r\n    expected_value = shap_values[:,-1][0]\r\n    print(expected_value.round(4))\r\n    # -0.5393\r\n```",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/shap/shap/issues/966/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/shap/shap/issues/966/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
