{
  "url": "https://api.github.com/repos/shap/shap/issues/982",
  "repository_url": "https://api.github.com/repos/shap/shap",
  "labels_url": "https://api.github.com/repos/shap/shap/issues/982/labels{/name}",
  "comments_url": "https://api.github.com/repos/shap/shap/issues/982/comments",
  "events_url": "https://api.github.com/repos/shap/shap/issues/982/events",
  "html_url": "https://github.com/shap/shap/issues/982",
  "id": 545280029,
  "node_id": "MDU6SXNzdWU1NDUyODAwMjk=",
  "number": 982,
  "title": "shap.DeepExplainer takes forever to finish for larget dataset",
  "user": {
    "login": "rwmasood",
    "id": 5518177,
    "node_id": "MDQ6VXNlcjU1MTgxNzc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5518177?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rwmasood",
    "html_url": "https://github.com/rwmasood",
    "followers_url": "https://api.github.com/users/rwmasood/followers",
    "following_url": "https://api.github.com/users/rwmasood/following{/other_user}",
    "gists_url": "https://api.github.com/users/rwmasood/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rwmasood/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rwmasood/subscriptions",
    "organizations_url": "https://api.github.com/users/rwmasood/orgs",
    "repos_url": "https://api.github.com/users/rwmasood/repos",
    "events_url": "https://api.github.com/users/rwmasood/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rwmasood/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 0,
  "created_at": "2020-01-04T12:33:35Z",
  "updated_at": "2020-01-04T12:33:35Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "Hi all,\r\n\r\nI have around half a million records for which I want to meausre shapely values. My backroung data set as recommended is 5k. I ran the below code and it never ends, even after couple of days. \r\n\r\n`explainer_shap = shap.DeepExplainer(model=tf_model, data=background)#, session = sess)\r\nshap_values = explainer_shap.explainer.shap_values(X=p_df.to_numpy(), ranked_outputs=True, check_additivity=False)\r\n`\r\n\r\nThen, to spice things up, I tired the following 3 different settings to speed up the process, I do have a 2 GPUs installed on my server though and have 48 cores. \r\n\r\nSetting 1:\r\n`config = tf.ConfigProto(device_count={'GPU':2, 'CPU':100})\r\n config = tf.ConfigProto(\r\n         intra_op_parallelism_threads=1000,\r\n         inter_op_parallelism_threads=1000)\r\n sess = tf.Session(config=config)\r\n K.set_session(sess)`\r\n\r\nSetting 2:\r\n` NUM_PARALLEL_EXEC_UNITS = 48\r\n config = tf.ConfigProto(\r\n                         intra_op_parallelism_threads=NUM_PARALLEL_EXEC_UNITS,\r\n                         inter_op_parallelism_threads=100,\r\n                         allow_soft_placement=True,\r\n                         device_count={'CPU': NUM_PARALLEL_EXEC_UNITS})\r\n sess = tf.Session(config=config)\r\n K.set_session(sess)`\r\n\r\nSetting 3:\r\n `os.environ[\"OMP_NUM_THREADS\"] = \"100\"\r\n os.environ[\"KMP_BLOCKTIME\"] = \"30\"\r\n os.environ[\"KMP_SETTINGS\"] = \"1\"\r\n os.environ[\"KMP_AFFINITY\"] = \"granularity=fine,verbose,compact,1,0\"\r\nos.environ[\"CUDA_DEVICE_ORDER\"]=\"PCI_BUS_ID\"  \r\nos.environ[\"CUDA_VISIBLE_DEVICES\"]=\"\"\r\nconfig = tf.ConfigProto(device_count={\"CPU\": 48, 'GPU':0})\r\nK.set_session(tf.Session(config=config))`\r\n\r\nBut there is no boost in the either CPU usage or memory. \r\n\r\n\r\nps aux always give the following stats:\r\n\r\n![grafik](https://user-images.githubusercontent.com/5518177/71765543-88ca1900-2ef6-11ea-9e70-e1ed48cff0c4.png)\r\n\r\n\r\nI reall need to get this thing going, can someone please adivce a way to boost the execution.\r\nMany thanks for your support. \r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/shap/shap/issues/982/reactions",
    "total_count": 1,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 1
  },
  "timeline_url": "https://api.github.com/repos/shap/shap/issues/982/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
