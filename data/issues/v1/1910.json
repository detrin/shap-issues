{
  "url": "https://api.github.com/repos/shap/shap/issues/1910",
  "repository_url": "https://api.github.com/repos/shap/shap",
  "labels_url": "https://api.github.com/repos/shap/shap/issues/1910/labels{/name}",
  "comments_url": "https://api.github.com/repos/shap/shap/issues/1910/comments",
  "events_url": "https://api.github.com/repos/shap/shap/issues/1910/events",
  "html_url": "https://github.com/shap/shap/issues/1910",
  "id": 842881608,
  "node_id": "MDU6SXNzdWU4NDI4ODE2MDg=",
  "number": 1910,
  "title": "ResourceExhaustedError when using KernelSHAP for small CNN",
  "user": {
    "login": "Jiachen-T-Wang",
    "id": 28067358,
    "node_id": "MDQ6VXNlcjI4MDY3MzU4",
    "avatar_url": "https://avatars.githubusercontent.com/u/28067358?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Jiachen-T-Wang",
    "html_url": "https://github.com/Jiachen-T-Wang",
    "followers_url": "https://api.github.com/users/Jiachen-T-Wang/followers",
    "following_url": "https://api.github.com/users/Jiachen-T-Wang/following{/other_user}",
    "gists_url": "https://api.github.com/users/Jiachen-T-Wang/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Jiachen-T-Wang/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Jiachen-T-Wang/subscriptions",
    "organizations_url": "https://api.github.com/users/Jiachen-T-Wang/orgs",
    "repos_url": "https://api.github.com/users/Jiachen-T-Wang/repos",
    "events_url": "https://api.github.com/users/Jiachen-T-Wang/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Jiachen-T-Wang/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 0,
  "created_at": "2021-03-29T01:00:09Z",
  "updated_at": "2021-03-29T02:39:32Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "Hi, thanks for creating this fantastic library. \r\n\r\nI am trying to use KernelSHAP to explain LeNet trained on MNIST, however I encounted ResourceExhaustedError as follows: \r\n`tensorflow.python.framework.errors_impl.ResourceExhaustedError: OOM when allocating tensor with shape[5000000,28,28,20] and type float on /job:localhost/replica:0/task:0/device:CPU:0 by allocator cpu [Op:Conv2D]`\r\n\r\nHere's my code: \r\n```python\r\nn_background_data = 500\r\nbackground = x_train[np.random.choice(x_train.shape[0], n_background_data, replace=False)]\r\nprint('Sample Background Data')\r\n\r\ntest_ind = (np.argmax(y_test, axis=1)==4).nonzero()[0][:20]\r\n\r\n### Create and Train LeNet model ...\r\n\r\nkernelshap = shap.KernelExplainer(model, background.reshape(n_background_data, -1))\r\nkernelshap_values = kernelshap.shap_values(x_test[test_ind].reshape(len(test_ind), -1), nsamples=10000, l1_reg=l1_reg)\r\n```\r\nand here's the architecture of LeNet: \r\n```python\r\nclass KerasLeNet:\r\n    @staticmethod\r\n    def build(numChannels, imgRows, imgCols, numClasses, activation=\"relu\", weightsPath=None):\r\n\r\n        model = Sequential()\r\n        inputShape = (imgRows, imgCols, numChannels)\r\n        if K.image_data_format() == \"channels_first\": inputShape = (numChannels, imgRows, imgCols)\r\n\r\n        if numChannels > 1:\r\n          inputShape = (numChannels, imgRows, imgCols)\r\n\r\n        model.add(Conv2D(20, 5, padding=\"same\", input_shape=inputShape))\r\n        model.add(Activation(activation))\r\n        model.add(MaxPooling2D(pool_size=(2, 2), strides=(2, 2)))\r\n        model.add(Conv2D(40, 5, padding=\"same\"))\r\n        model.add(Activation(activation))\r\n        model.add(MaxPooling2D(pool_size=(2, 2), strides=(2, 2)))\r\n        model.add(keras.layers.core.Flatten())\r\n        model.add(Dense(500))\r\n        model.add(Activation(activation))\r\n        model.add(Dense(numClasses))\r\n        model.add(Activation(\"softmax\"))\r\n\r\n        if weightsPath is not None:\r\n            model.load_weights(weightsPath)\r\n\r\n        return model\r\n```\r\n\r\nIs there anyway I could reduce the memory consumption? I want to reproduce the experiment 5.3 in the SHAP paper (https://arxiv.org/abs/1705.07874), where it used 50k samples. Any suggestions are welcome!\r\n\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/shap/shap/issues/1910/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/shap/shap/issues/1910/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
