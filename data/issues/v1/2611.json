{
  "url": "https://api.github.com/repos/shap/shap/issues/2611",
  "repository_url": "https://api.github.com/repos/shap/shap",
  "labels_url": "https://api.github.com/repos/shap/shap/issues/2611/labels{/name}",
  "comments_url": "https://api.github.com/repos/shap/shap/issues/2611/comments",
  "events_url": "https://api.github.com/repos/shap/shap/issues/2611/events",
  "html_url": "https://github.com/shap/shap/issues/2611",
  "id": 1297564759,
  "node_id": "I_kwDOBHDcK85NV0RX",
  "number": 2611,
  "title": "Can't retrieve SHAP values from scikit-learn Pipeline?",
  "user": {
    "login": "steve-solun",
    "id": 108329117,
    "node_id": "U_kgDOBnT4nQ",
    "avatar_url": "https://avatars.githubusercontent.com/u/108329117?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/steve-solun",
    "html_url": "https://github.com/steve-solun",
    "followers_url": "https://api.github.com/users/steve-solun/followers",
    "following_url": "https://api.github.com/users/steve-solun/following{/other_user}",
    "gists_url": "https://api.github.com/users/steve-solun/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/steve-solun/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/steve-solun/subscriptions",
    "organizations_url": "https://api.github.com/users/steve-solun/orgs",
    "repos_url": "https://api.github.com/users/steve-solun/repos",
    "events_url": "https://api.github.com/users/steve-solun/events{/privacy}",
    "received_events_url": "https://api.github.com/users/steve-solun/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2022-07-07T14:40:25Z",
  "updated_at": "2023-07-24T09:32:36Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "@slundberg \r\nI am trying to retrieve SHAP values to explain new input predictions with a predefined pipe but getting an error you can find in the end.\r\nPlease advise how can I fix it?\r\n\r\nLink to data: https://sharetext.me/bd68ryvzi0\r\n\r\nCode:\r\n\r\n    import pandas as pd\r\n    \r\n    from sklearn.feature_extraction.text import TfidfVectorizer\r\n    from sklearn.preprocessing import FunctionTransformer\r\n    from sklearn.model_selection import train_test_split\r\n    from sklearn.ensemble import RandomForestClassifier\r\n    from sklearn.pipeline import Pipeline\r\n    \r\n    # Loading GitHub Repos data containing code and comments from 2.8 million GitHub repositories:\r\n    DATA_PATH = r\"sample.csv\"\r\n    \r\n    data = pd.read_csv(DATA_PATH, dtype='object')\r\n    data = data.convert_dtypes()\r\n    data = data.dropna()\r\n    data = data.drop_duplicates()\r\n    \r\n    # Train/Test split\r\n    X, y = data.content, data.language\r\n    X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, stratify=y)\r\n    \r\n    # Model params to match:\r\n    # 1. Variable and module names, words in a string, keywords: [A-Za-z_]\\w*\\b\r\n    # 2. Operators: [!\\#\\$%\\&\\*\\+:\\-\\./<=>\\?@\\\\\\^_\\|\\~]+\r\n    # 3. Tabs, spaces and Brackets: [ \\t\\(\\),;\\{\\}\\[\\]`\"']\r\n    # with the following regex:\r\n    token_pattern = r\"\"\"(\\b[A-Za-z_]\\w*\\b|[!\\#\\$%\\&\\*\\+:\\-\\./<=>\\?@\\\\\\^_\\|\\~]+|[ \\t\\(\\),;\\{\\}\\[\\]`\"'])\"\"\"\r\n    \r\n    \r\n    def preprocess(x):\r\n     \"\"\" Clean up single-character variable names or ones constituted of a sequence of the same character \"\"\"\r\n     return pd.Series(x).replace(r'\\b([A-Za-z])\\1+\\b', '', regex=True)\\\r\n     .replace(r'\\b[A-Za-z]\\b', '', regex=True)\r\n    \r\n    \r\n    # Pipe steps:\r\n    # Define a transformer:\r\n    transformer = FunctionTransformer(preprocess)\r\n    # Perform TF-IDF vectorization with our token pattern:\r\n    vectorizer = TfidfVectorizer(token_pattern=token_pattern, max_features=3000)\r\n    # Create Random Forest Classifier:\r\n    clf = RandomForestClassifier(n_jobs=4)\r\n    \r\n    pipe_RF = Pipeline([\r\n     ('preprocessing', transformer),\r\n     ('vectorizer', vectorizer),\r\n     ('clf', clf)]\r\n    )\r\n    \r\n    # Setting best params (after performing GridSearchCV)\r\n    best_params = {\r\n     'clf__criterion': 'gini',\r\n     'clf__max_features': 'sqrt',\r\n     'clf__min_samples_split': 3,\r\n     'clf__n_estimators': 300\r\n    }\r\n    \r\n    pipe_RF.set_params(**best_params)\r\n    \r\n    # Fitting\r\n    pipe_RF.fit(X_train, y_train)\r\n    \r\n    # Evaluation\r\n    print(f'Accuracy: {pipe_RF.score(X_test, y_test)}')\r\n    \r\n    \r\n    \r\n    user_input = [\"\"\" public class Fibonacci {\r\n    \r\n    public static void main(String[] args) {\r\n    \r\n    int n = 10;\r\n    \r\n    System.out.println(fib(n));\r\n    \r\n    }\r\n    \r\n    public static int fib(int n) {\r\n    \r\n    if (n <= 1) {\r\n    \r\n    return n;\r\n    \r\n    }\r\n    \r\n    return fib(n - 1) + fib(n - 2);\r\n    \r\n    }\r\n    \r\n    } \"\"\"]\r\n    \r\n    \r\n    import shap\r\n    \r\n    shap.initjs()\r\n    explainer = shap.TreeExplainer(pipe_RF.named_steps['clf'])\r\n    observation = pipe_RF[:-1].transform(user_input).toarray()\r\n    shap_values = explainer.shap_values(observation)\r\n\r\nLoad the data and run it to get the following error:\r\n\r\n> ExplainerError: Additivity check failed in TreeExplainer! Please\r\n> ensure the data matrix you passed to the explainer is the same shape\r\n> that the model was trained on. If your data shape is correct then\r\n> please report this on GitHub. Consider retrying with the\r\n> feature_perturbation='interventional' option. This check failed\r\n> because for one of the samples the sum of the SHAP values was\r\n> 46609069202029743624438153216.000000, while the model output was 0.004444. If this difference is acceptable you can set check_additivity=False to disable this check.\r\n\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/shap/shap/issues/2611/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/shap/shap/issues/2611/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
