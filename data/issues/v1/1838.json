{
  "url": "https://api.github.com/repos/shap/shap/issues/1838",
  "repository_url": "https://api.github.com/repos/shap/shap",
  "labels_url": "https://api.github.com/repos/shap/shap/issues/1838/labels{/name}",
  "comments_url": "https://api.github.com/repos/shap/shap/issues/1838/comments",
  "events_url": "https://api.github.com/repos/shap/shap/issues/1838/events",
  "html_url": "https://github.com/shap/shap/issues/1838",
  "id": 815339623,
  "node_id": "MDU6SXNzdWU4MTUzMzk2MjM=",
  "number": 1838,
  "title": "NGBRegressor col_sample < 1 shap_values don't add up to prediction",
  "user": {
    "login": "matthiasschuurmans",
    "id": 9294778,
    "node_id": "MDQ6VXNlcjkyOTQ3Nzg=",
    "avatar_url": "https://avatars.githubusercontent.com/u/9294778?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/matthiasschuurmans",
    "html_url": "https://github.com/matthiasschuurmans",
    "followers_url": "https://api.github.com/users/matthiasschuurmans/followers",
    "following_url": "https://api.github.com/users/matthiasschuurmans/following{/other_user}",
    "gists_url": "https://api.github.com/users/matthiasschuurmans/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/matthiasschuurmans/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/matthiasschuurmans/subscriptions",
    "organizations_url": "https://api.github.com/users/matthiasschuurmans/orgs",
    "repos_url": "https://api.github.com/users/matthiasschuurmans/repos",
    "events_url": "https://api.github.com/users/matthiasschuurmans/events{/privacy}",
    "received_events_url": "https://api.github.com/users/matthiasschuurmans/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 0,
  "created_at": "2021-02-24T10:26:51Z",
  "updated_at": "2021-02-24T10:26:51Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "Hi all, I've been playing around with the NGBRegressor, and came across a weird problem: when I put col_sample to below 1, shap_values plus the expected value don't add up to the prediction. I tried the same with XGBRegressor (`colsample_bytree`) and don't encounter this issue there. Furthermore, shap's own `check_additivity` also does not have this problem. See below for a code snippet.\r\n\r\n```\r\nfrom sklearn.datasets import load_boston\r\nimport numpy as np\r\nimport pandas as pd\r\nimport xgboost\r\nfrom ngboost import NGBRegressor\r\nimport shap\r\n\r\n\r\nCOL_SAMPLE = 0.99\r\n\r\nX, Y = load_boston(True)\r\nmodel = NGBRegressor(col_sample=COL_SAMPLE).fit(X, Y)\r\n#model = xgboost.XGBRegressor(colsample_bytree=COL_SAMPLE).fit(X, Y)\r\n\r\n# Shaps check_additivity\r\nexplainer = shap.TreeExplainer(model)\r\nshap_values = explainer.shap_values(X, check_additivity=True)\r\n\r\n# Own check\r\nY_preds = model.predict(X)\r\nshap_values = pd.DataFrame(shap_values)\r\nif 'ngboost' in str(type(model)):\r\n    shap_values['expected_value'] = explainer.expected_value[0]\r\nelse:\r\n    shap_values['expected_value'] = explainer.expected_value\r\nsum_diff = np.sum(abs(shap_values.sum(axis=1) - Y_preds))\r\nprint('sum diff = {}'.format(sum_diff))\r\n```\r\n\r\nYou can play around with the `COL_SAMPLE` constant and what model is being trained, NGBRegressor or XGBRegressor. \r\n\r\nI dug a bit into why `check_additivity` does not fail for NGBRegressor with col_sample < 1, I think it's because it does not take into account the col_sample value of the model when creating a TreeEnsemble of the NGBRegressor in https://github.com/slundberg/shap/blob/master/shap/explainers/_tree.py#L959 , and so calling `self.model.predict()` in https://github.com/slundberg/shap/blob/master/shap/explainers/_tree.py#L406 also does not take the col_sample < 1 into account.\r\n\r\nI'm guessing this is not a problem for the XGBRegressor, because the TreeEnsemble gets created in a more complete way, also taking col_sample_bytree < 1 into account at https://github.com/slundberg/shap/blob/master/shap/explainers/_tree.py#L841\r\n\r\nThanks!",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/shap/shap/issues/1838/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/shap/shap/issues/1838/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
