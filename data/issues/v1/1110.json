{
  "url": "https://api.github.com/repos/shap/shap/issues/1110",
  "repository_url": "https://api.github.com/repos/shap/shap",
  "labels_url": "https://api.github.com/repos/shap/shap/issues/1110/labels{/name}",
  "comments_url": "https://api.github.com/repos/shap/shap/issues/1110/comments",
  "events_url": "https://api.github.com/repos/shap/shap/issues/1110/events",
  "html_url": "https://github.com/shap/shap/issues/1110",
  "id": 584498553,
  "node_id": "MDU6SXNzdWU1ODQ0OTg1NTM=",
  "number": 1110,
  "title": "shap_values fails to run on keras model with BatchNormalization layer",
  "user": {
    "login": "PPere5",
    "id": 47524998,
    "node_id": "MDQ6VXNlcjQ3NTI0OTk4",
    "avatar_url": "https://avatars.githubusercontent.com/u/47524998?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/PPere5",
    "html_url": "https://github.com/PPere5",
    "followers_url": "https://api.github.com/users/PPere5/followers",
    "following_url": "https://api.github.com/users/PPere5/following{/other_user}",
    "gists_url": "https://api.github.com/users/PPere5/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/PPere5/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/PPere5/subscriptions",
    "organizations_url": "https://api.github.com/users/PPere5/orgs",
    "repos_url": "https://api.github.com/users/PPere5/repos",
    "events_url": "https://api.github.com/users/PPere5/events{/privacy}",
    "received_events_url": "https://api.github.com/users/PPere5/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 23,
  "created_at": "2020-03-19T15:33:11Z",
  "updated_at": "2023-02-10T01:52:01Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "Hi,\r\n\r\nAfter banging my head against the problem for the past hours I decided to please ask for your assistance.\r\n\r\nI am working with a keras model with the following layout:\r\n\r\n```\r\n____________________________________________________________\r\nLayer (type)                 Output Shape              Param #\r\n=================================================================\r\ninput_1 (InputLayer)         [(None, 53)]              0\r\n_________________________________________________________________\r\nbatch_normalization (BatchNo (None, 53)                212       \r\n_________________________________________________________________\r\nactivation (Activation)      (None, 53)                0\r\n_________________________________________________________________\r\nh1 (Dense)                   (None, 64)                3456\r\n_________________________________________________________________\r\nbatch_normalization_1 (Batch (None, 64)                256\r\n_________________________________________________________________\r\nactivation_1 (Activation)    (None, 64)                0\r\n_________________________________________________________________\r\nh2 (Dense)                   (None, 64)                4160\r\n_________________________________________________________________\r\nbatch_normalization_2 (Batch (None, 64)                256\r\n_________________________________________________________________\r\nactivation_2 (Activation)    (None, 64)                0\r\n_________________________________________________________________\r\nh3 (Dense)                   (None, 64)                4160\r\n_________________________________________________________________\r\nbatch_normalization_3 (Batch (None, 64)                256\r\n_________________________________________________________________\r\nactivation_3 (Activation)    (None, 64)                0\r\n_________________________________________________________________\r\nh4 (Dense)                   (None, 32)                2080\r\n_________________________________________________________________\r\nbatch_normalization_4 (Batch (None, 32)                128\r\n_________________________________________________________________\r\nactivation_4 (Activation)    (None, 32)                0\r\n_________________________________________________________________\r\nh5 (Dense)                   (None, 16)                528\r\n_________________________________________________________________\r\nbatch_normalization_5 (Batch (None, 16)                64\r\n_________________________________________________________________\r\nactivation_5 (Activation)    (None, 16)                0\r\n_________________________________________________________________\r\n=================================================================\r\nTotal params: 15,573\r\nTrainable params: 14,987\r\nNon-trainable params: 586\r\n_________________________________________________________________\r\n\r\n```\r\nafter training the model, running:\r\n\r\nexplainer = shap.DeepExplainer(loaded_model, data)\r\nshap_values = explainer.shap_values(data, check_additivity= False)\r\n\r\n\r\n(sorry I cannot share the whole code confidentiality and such...)\r\n\r\nwill return an error:\r\n\r\n\r\n```\r\n    C:\\Users\\p\\Virtual_Environments\\env-ml\\lib\\site-packages\\shap\\explainers\\deep\\deep_tf.py:244 grad_graph  *\r\n    C:\\Users\\p\\Virtual_Environments\\env-ml\\lib\\site-packages\\tensorflow_core\\python\\eager\\backprop.py:1029 gradient\r\n        unconnected_gradients=unconnected_gradients)\r\n    C:\\Users\\p\\Virtual_Environments\\env-ml\\lib\\site-packages\\tensorflow_core\\python\\eager\\imperative_grad.py:77 imperative_grad\r\n        compat.as_str(unconnected_gradients.value))\r\n    C:\\Users\\p\\Virtual_Environments\\env-ml\\lib\\site-packages\\tensorflow_core\\python\\eager\\backprop.py:137 _gradient_function\r\n        grad_fn = ops._gradient_registry.lookup(op_name)  # pylint: disable=protected-access\r\n    C:\\Users\\p\\Virtual_Environments\\env-ml\\lib\\site-packages\\tensorflow_core\\python\\framework\\registry.py:97 lookup\r\n        \"%s registry has no entry for: %s\" % (self._name, name))\r\n\r\n    LookupError: gradient registry has no entry for: shap_AddV2\r\n\r\n\r\n```\r\nSame code runs fine if I alter the model to remove batchnorm layers. I am using tensorflow 2.1.\r\nCould you please shed some light on this issue?\r\n\r\nThank you!\r\n\r\n\r\n\r\n\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/shap/shap/issues/1110/reactions",
    "total_count": 15,
    "+1": 15,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/shap/shap/issues/1110/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
