{
  "url": "https://api.github.com/repos/shap/shap/issues/3121",
  "repository_url": "https://api.github.com/repos/shap/shap",
  "labels_url": "https://api.github.com/repos/shap/shap/issues/3121/labels{/name}",
  "comments_url": "https://api.github.com/repos/shap/shap/issues/3121/comments",
  "events_url": "https://api.github.com/repos/shap/shap/issues/3121/events",
  "html_url": "https://github.com/shap/shap/pull/3121",
  "id": 1816673281,
  "node_id": "PR_kwDOBHDcK85WJLfy",
  "number": 3121,
  "title": "fix!: Standardize the shape of `Explanation.base_values` of TreeExplainers",
  "user": {
    "login": "thatlittleboy",
    "id": 30731072,
    "node_id": "MDQ6VXNlcjMwNzMxMDcy",
    "avatar_url": "https://avatars.githubusercontent.com/u/30731072?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/thatlittleboy",
    "html_url": "https://github.com/thatlittleboy",
    "followers_url": "https://api.github.com/users/thatlittleboy/followers",
    "following_url": "https://api.github.com/users/thatlittleboy/following{/other_user}",
    "gists_url": "https://api.github.com/users/thatlittleboy/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/thatlittleboy/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/thatlittleboy/subscriptions",
    "organizations_url": "https://api.github.com/users/thatlittleboy/orgs",
    "repos_url": "https://api.github.com/users/thatlittleboy/repos",
    "events_url": "https://api.github.com/users/thatlittleboy/events{/privacy}",
    "received_events_url": "https://api.github.com/users/thatlittleboy/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 486901329,
      "node_id": "MDU6TGFiZWw0ODY5MDEzMjk=",
      "url": "https://api.github.com/repos/shap/shap/labels/bug",
      "name": "bug",
      "color": "ee0701",
      "default": true,
      "description": "Indicates an unexpected problem or unintended behaviour"
    },
    {
      "id": 5762965052,
      "node_id": "LA_kwDOBHDcK88AAAABV3_ePA",
      "url": "https://api.github.com/repos/shap/shap/labels/BREAKING",
      "name": "BREAKING",
      "color": "d93f0b",
      "default": false,
      "description": "Indicates that a PR is introducing a breaking change"
    }
  ],
  "state": "open",
  "locked": false,
  "assignee": {
    "login": "thatlittleboy",
    "id": 30731072,
    "node_id": "MDQ6VXNlcjMwNzMxMDcy",
    "avatar_url": "https://avatars.githubusercontent.com/u/30731072?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/thatlittleboy",
    "html_url": "https://github.com/thatlittleboy",
    "followers_url": "https://api.github.com/users/thatlittleboy/followers",
    "following_url": "https://api.github.com/users/thatlittleboy/following{/other_user}",
    "gists_url": "https://api.github.com/users/thatlittleboy/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/thatlittleboy/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/thatlittleboy/subscriptions",
    "organizations_url": "https://api.github.com/users/thatlittleboy/orgs",
    "repos_url": "https://api.github.com/users/thatlittleboy/repos",
    "events_url": "https://api.github.com/users/thatlittleboy/events{/privacy}",
    "received_events_url": "https://api.github.com/users/thatlittleboy/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "thatlittleboy",
      "id": 30731072,
      "node_id": "MDQ6VXNlcjMwNzMxMDcy",
      "avatar_url": "https://avatars.githubusercontent.com/u/30731072?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/thatlittleboy",
      "html_url": "https://github.com/thatlittleboy",
      "followers_url": "https://api.github.com/users/thatlittleboy/followers",
      "following_url": "https://api.github.com/users/thatlittleboy/following{/other_user}",
      "gists_url": "https://api.github.com/users/thatlittleboy/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/thatlittleboy/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/thatlittleboy/subscriptions",
      "organizations_url": "https://api.github.com/users/thatlittleboy/orgs",
      "repos_url": "https://api.github.com/users/thatlittleboy/repos",
      "events_url": "https://api.github.com/users/thatlittleboy/events{/privacy}",
      "received_events_url": "https://api.github.com/users/thatlittleboy/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": {
    "url": "https://api.github.com/repos/shap/shap/milestones/2",
    "html_url": "https://github.com/shap/shap/milestone/2",
    "labels_url": "https://api.github.com/repos/shap/shap/milestones/2/labels",
    "id": 9579906,
    "node_id": "MI_kwDOBHDcK84Aki2C",
    "number": 2,
    "title": "0.43.0",
    "description": "",
    "creator": {
      "login": "thatlittleboy",
      "id": 30731072,
      "node_id": "MDQ6VXNlcjMwNzMxMDcy",
      "avatar_url": "https://avatars.githubusercontent.com/u/30731072?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/thatlittleboy",
      "html_url": "https://github.com/thatlittleboy",
      "followers_url": "https://api.github.com/users/thatlittleboy/followers",
      "following_url": "https://api.github.com/users/thatlittleboy/following{/other_user}",
      "gists_url": "https://api.github.com/users/thatlittleboy/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/thatlittleboy/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/thatlittleboy/subscriptions",
      "organizations_url": "https://api.github.com/users/thatlittleboy/orgs",
      "repos_url": "https://api.github.com/users/thatlittleboy/repos",
      "events_url": "https://api.github.com/users/thatlittleboy/events{/privacy}",
      "received_events_url": "https://api.github.com/users/thatlittleboy/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 10,
    "closed_issues": 23,
    "state": "open",
    "created_at": "2023-06-25T10:11:50Z",
    "updated_at": "2023-08-26T14:27:48Z",
    "due_on": null,
    "closed_at": null
  },
  "comments": 9,
  "created_at": "2023-07-22T08:03:54Z",
  "updated_at": "2023-08-26T10:39:03Z",
  "closed_at": null,
  "author_association": "COLLABORATOR",
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/shap/shap/pulls/3121",
    "html_url": "https://github.com/shap/shap/pull/3121",
    "diff_url": "https://github.com/shap/shap/pull/3121.diff",
    "patch_url": "https://github.com/shap/shap/pull/3121.patch",
    "merged_at": null
  },
  "body": "## Overview\r\n\r\nDescription of the changes proposed in this pull request:\r\n\r\n* (!) Standardize the shape of `Explanation.base_values` of `TreeExplainers`, to make it more predictable. In short:\r\n    * We will now no longer get `base_values` arrays of shape `(N,1)`, it will be of shape `(N,)` instead. Otherwise `(N,2)` etc. for multioutput models.\r\n    * Read the background for this change below.\r\n    * An **API-breaking** change.\r\n* Add tests for all the major TreeExplainer types (lightgbm, xgboost, sklearn, catboost, ...) and also tried to cover regression / binary classification / multiclass classification as far as possible.\r\n    * Tests are now **explicitly** testing for the shapes on the `.base_values` and `.values` arrays. \r\n    * <s>`XGBRegressor` is notably missing from the coverage here, I will add a test for this eventually when I do a overhaul of the xgboost tests. (created an issue #3123 to track this)</s>\r\n\r\nThe code change is fairly simple, but the implications are potentially big.  \r\nTo reviewers: For API breaking changes like this, I would advocate for having at least 2 members approving the PR before the merge, if possible.\r\n\r\n---\r\n\r\n## Background\r\n\r\nWe have received a slew of bug reports arising from the inconsistencies of the shapes of `Explanation.base_values`, which causes `IndexError` problems when users input these `Explanation` objects into our plotting functions.\r\n\r\nSee issues #2255, #2855 , #2140, #1801 for more background and in-depth diagnosis. In short, we have some tree explainers that give a `Explanation.base_values.shape` of `(N,1)` while others give `(N,)`. Which results in users having to write hacks like [this](https://github.com/shap/shap/issues/1801#issuecomment-811091856) or [this](https://github.com/shap/shap/issues/2255#issuecomment-962260490) to get around the inconsistency.\r\n\r\n### What is the inconsistency, *exactly*?\r\n\r\nConsider the following:\r\n\r\n```python\r\nimport xgboost\r\nimport sklearn\r\nimport shap\r\n\r\nX, y = shap.datasets.adult(n_points=500)\r\n\r\n# === xgboost ===\r\nclf = xgboost.XGBRegressor().fit(X, y)\r\nexplainer = shap.Explainer(clf)\r\nexplanation = explainer(X)\r\nprint(f\"XGboost {explanation.base_values.shape=}\")  # (500,)\r\nshap.plots.waterfall(explanation[0], show=False)  # no Error!\r\n\r\n\r\n# === sklearn ===\r\nclf = sklearn.ensemble.RandomForestRegressor().fit(X, y)\r\nexplainer = shap.Explainer(clf)\r\nexplanation = explainer(X)\r\nprint(f\"Sklearn {explanation.base_values.shape=}\")  # (500,1)\r\nshap.plots.waterfall(explanation[0], show=False)  # throws Error!\r\n```\r\n\r\nThe code is exactly the same, only a different regressor was used. Yet one throws an error, and the other doesn't.  \r\nSee below for the list of affected models (those that used to return a basevalues shape `(N,1)` before this PR).\r\n\r\n### What are the alternatives instead of the decisions made in this PR?\r\n\r\n1. We can make all of our plotting functions (e.g. `shap.plots.bar`, `shap.plots.waterfall`, ...) all handle this shape inconsistency internally. But that's just a workaround which is prone to failing in the future. See an example PR here: PR #2667.\r\n2. **Note** that only the output of `Tree.__call__()` is standardized here, not `Tree.expected_value`. Which would itself also be a breaking change itself.\r\n    * We can definitely consider standardizing `Tree.expected_value` in the future, but this decision shouldn't make-or-break this PR.\r\n    * The reason I didn't standardize `expected_value` of the TreeExplainer's yet is just that the changes there is potentially more complicated. We have to look into every Tree implementation and ensure the output shapes are consistent. This PR alone is sufficient to close off most of the problems that people are facing with `base_values` shape, and we can take this opportunity to educate users to use `Explanation` objects as *the standard* API instead of using the raw expected value on the Explainer.\r\n    * There is a *related* problem where the various Tree's give inconsistent shapes of the SHAP values array. The biggest offender is the binary classification case with `XGBClassifier` and `LGBMClassifier`. The former returns a `(N,k)` array, while the latter returns a list of `(N,k)` arrays. For other examples, scan through the tests in `test_tree.py` and compare the `explanation.values.shape` across the various scenarios. I think if we ever standardize `Tree.expected_value`, it should be executed/standardized together with the `Tree.shap_values()` output.\r\n\r\n### Which models are *actually* affected?\r\n\r\nFirst of all, it's important to note that none of the other Explainers are affected, only `TreeExplainer`.  \r\n\r\nThese are the models & tests that changed from failing -> passing when we made this breaking change:\r\n\r\n- Model: `sklearn.ensemble.GradientBoostingClassifier`\r\n    - `tests/explainers/test_tree.py::TestExplainerSklearn::test_sum_match_gradient_boosting_classifier`\r\n- Model: `sklearn.ensemble.GradientBoostingRegressor`\r\n    - `tests/explainers/test_tree.py::TestExplainerSklearn::test_sum_match_gradient_boosting_regressor`\r\n- Model: `sklearn.ensemble.HistGradientBoostingRegressor`\r\n    - `tests/explainers/test_tree.py::TestExplainerSklearn::test_HistGradientBoostingRegressor`\r\n-  Model: `sklearn.ensemble.IsolationForest`\r\n    - `tests/explainers/test_tree.py::test_isolation_forest`\r\n- Model: `pyod.models.iforest`\r\n    - `tests/explainers/test_tree.py::test_pyod_isolation_forest`\r\n- Model: `ngboost.NGBRegressor`\r\n    - `tests/explainers/test_tree.py::test_ngboost`\r\n- Model: `gpboost.GPModel`\r\n    - `tests/explainers/test_tree.py::test_gpboost`\r\n\r\nAll of the above models & associated TreeExplainers had their `Explanation.base_values.shape` change from `(N,1)` to `(N,)`.  \r\nAs far as I could tell, the other supported Tree models are not affected.\r\n\r\n### What is the final benefit / result?\r\n\r\nAll TreeExplainer's models should be able to run the example at the beginning of the post now, without having to fumble around with the array shapes. 🎉\r\n\r\n## Checklist\r\n\r\n- [X] Closes #2255, closes #2855 , closes #2140. Related to #1420, #1801. Also, we can close #2667 after this PR is merged.\r\n- [X] All [pre-commit checks](https://pre-commit.com/#install) pass.\r\n- [X] Unit tests added (if fixing a bug or adding a new feature)\r\n- [ ] Added entry to `CHANGELOG.md` (if changes will affect users)\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/shap/shap/issues/3121/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/shap/shap/issues/3121/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
