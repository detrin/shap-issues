{
  "url": "https://api.github.com/repos/shap/shap/issues/142",
  "repository_url": "https://api.github.com/repos/shap/shap",
  "labels_url": "https://api.github.com/repos/shap/shap/issues/142/labels{/name}",
  "comments_url": "https://api.github.com/repos/shap/shap/issues/142/comments",
  "events_url": "https://api.github.com/repos/shap/shap/issues/142/events",
  "html_url": "https://github.com/shap/shap/issues/142",
  "id": 338315058,
  "node_id": "MDU6SXNzdWUzMzgzMTUwNTg=",
  "number": 142,
  "title": "Memory Leaks in TreeExplainer due to unclosed child processes",
  "user": {
    "login": "tgrondier",
    "id": 5384645,
    "node_id": "MDQ6VXNlcjUzODQ2NDU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5384645?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tgrondier",
    "html_url": "https://github.com/tgrondier",
    "followers_url": "https://api.github.com/users/tgrondier/followers",
    "following_url": "https://api.github.com/users/tgrondier/following{/other_user}",
    "gists_url": "https://api.github.com/users/tgrondier/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tgrondier/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tgrondier/subscriptions",
    "organizations_url": "https://api.github.com/users/tgrondier/orgs",
    "repos_url": "https://api.github.com/users/tgrondier/repos",
    "events_url": "https://api.github.com/users/tgrondier/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tgrondier/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2018-07-04T15:22:19Z",
  "updated_at": "2018-07-18T12:42:11Z",
  "closed_at": "2018-07-06T16:19:29Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "Hi Scott,\r\n\r\nI think I have identified a problem in the implementation of TreeExplainer that produces huge memory leaks on some devices.\r\n\r\nHere is a sample code:\r\n\r\n\r\n```\r\n#imports\r\n...\r\nmodel_names_list = #list of models\r\n\r\ndef start():\r\n\r\n    for model_name in model_names_list:\r\n        #pickle model from disk\r\n        ...\r\n        shap_values = shap.TreeExplainer(model).shap_values(data)\r\n\r\n        #pickle shap values to disk\r\n        ...\r\n\r\n       #end of loop, no side effects\r\n\r\nif __name__ == \"__main__\":\r\n    start()\r\n\r\n\r\n```\r\n\r\nOn one of my servers (Ubuntu 16.04.4 , Kernel Linux 4.4.0-1052-aws), the `shap.TreeExplainer(model).shap_values(data)` will leave behind a list of idle child processes which are not garbage collected, each occupying a non insignificant chunk of memory until the program shuts down, sometimes taking the server down with it. The more TreeExplainers you use, the longer the list of idle child processes get, and they don't always get cleared on program exit. Here is an example of what I am saying:\r\n\r\n![image](https://user-images.githubusercontent.com/5384645/42284256-3b8db034-7fac-11e8-9483-b7395d6f4b13.png)\r\n\r\nYou can see that there are a bunch of processes that are idle but occupy memory; they stay idle and often stay alive after the execution of the script.\r\n\r\nIt doesn't happen on my personal devices (Windows 10 version 10.0.17134 Build 17134 and Ubuntu 16.0.1 Kernel 4.15.0-24-generic. All devices are running either Python 3.5 or 3.6), which is why I looked into the code of the library and came accross what I believe to be the cause of the bug: https://github.com/slundberg/shap/blob/d79965b976de9d200a4e698fdbcbc608089ae232/shap/explainers/tree.py#L174 and https://github.com/slundberg/shap/blob/d79965b976de9d200a4e698fdbcbc608089ae232/shap/explainers/tree.py#L233. \r\n\r\nIt appears ot me that the pools should call ```pool.join()``` after ```pool.close()``` to avoid similar issues, as shown for example in https://stackoverflow.com/questions/38271547/when-should-we-call-multiprocessing-pool-join . \r\n\r\nI'm unfortunately not able to check on my side and do a pull request in the near future, so I was hoping you could look into it.",
  "closed_by": {
    "login": "slundberg",
    "id": 3740613,
    "node_id": "MDQ6VXNlcjM3NDA2MTM=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3740613?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/slundberg",
    "html_url": "https://github.com/slundberg",
    "followers_url": "https://api.github.com/users/slundberg/followers",
    "following_url": "https://api.github.com/users/slundberg/following{/other_user}",
    "gists_url": "https://api.github.com/users/slundberg/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/slundberg/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/slundberg/subscriptions",
    "organizations_url": "https://api.github.com/users/slundberg/orgs",
    "repos_url": "https://api.github.com/users/slundberg/repos",
    "events_url": "https://api.github.com/users/slundberg/events{/privacy}",
    "received_events_url": "https://api.github.com/users/slundberg/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/shap/shap/issues/142/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/shap/shap/issues/142/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
