{
  "url": "https://api.github.com/repos/shap/shap/issues/608",
  "repository_url": "https://api.github.com/repos/shap/shap",
  "labels_url": "https://api.github.com/repos/shap/shap/issues/608/labels{/name}",
  "comments_url": "https://api.github.com/repos/shap/shap/issues/608/comments",
  "events_url": "https://api.github.com/repos/shap/shap/issues/608/events",
  "html_url": "https://github.com/shap/shap/issues/608",
  "id": 448242782,
  "node_id": "MDU6SXNzdWU0NDgyNDI3ODI=",
  "number": 608,
  "title": "KernelExplainer keep_index error with kmeans",
  "user": {
    "login": "jamesmyatt",
    "id": 1047337,
    "node_id": "MDQ6VXNlcjEwNDczMzc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1047337?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jamesmyatt",
    "html_url": "https://github.com/jamesmyatt",
    "followers_url": "https://api.github.com/users/jamesmyatt/followers",
    "following_url": "https://api.github.com/users/jamesmyatt/following{/other_user}",
    "gists_url": "https://api.github.com/users/jamesmyatt/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jamesmyatt/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jamesmyatt/subscriptions",
    "organizations_url": "https://api.github.com/users/jamesmyatt/orgs",
    "repos_url": "https://api.github.com/users/jamesmyatt/repos",
    "events_url": "https://api.github.com/users/jamesmyatt/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jamesmyatt/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2019-05-24T15:57:17Z",
  "updated_at": "2021-09-07T09:44:39Z",
  "closed_at": null,
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "Since my data are in pandas DataFrames, I'd like to use the keep_index features of the KernelExplainer. However, with the following code:\r\n\r\n```\r\ndata = shap.kmeans(X_train, 10)\r\nexplainer = shap.KernelExplainer(model.predict_proba, data, keep_index=True)\r\nshap_values = explainer.shap_values(X_test, nsamples=100, l1_reg=\"num_features(10)\")\r\n```\r\n\r\nI get the error:\r\n```\r\n---------------------------------------------------------------------------\r\nC:\\Apps\\miniconda3\\envs\\xai_demos\\lib\\site-packages\\shap\\explainers\\kernel.py in shap_values(self, X, **kwargs)\r\n    207                 if self.keep_index:\r\n    208                     data = convert_to_instance_with_index(data, column_name, index_value[i:i + 1], index_name)\r\n--> 209                 explanations.append(self.explain(data, **kwargs))\r\n    210 \r\n    211             # vector-output\r\n\r\nC:\\Apps\\miniconda3\\envs\\xai_demos\\lib\\site-packages\\shap\\explainers\\kernel.py in explain(self, incoming_instance, **kwargs)\r\n    289 \r\n    290             # reserve space for some of our computations\r\n--> 291             self.allocate()\r\n    292 \r\n    293             # weight the different subset sizes\r\n\r\nC:\\Apps\\miniconda3\\envs\\xai_demos\\lib\\site-packages\\shap\\explainers\\kernel.py in allocate(self)\r\n    477         self.nsamplesRun = 0\r\n    478         if self.keep_index:\r\n--> 479             self.synth_data_index = np.tile(self.data.index_value, self.nsamples)\r\n    480 \r\n    481     def addsample(self, x, m, w):\r\n\r\nAttributeError: 'DenseData' object has no attribute 'index_value'\r\n```\r\n\r\nI think there's a fundamental assumption in KernelExplainer that keep_index results in data being stored in a DenseDataWithIndex object, while kmeans returns only a DenseData object. However, there's a mismatch when kmeans is used to summarise the data first, since the original data are now missing the index, while the data for shap_values aren't.\r\n\r\nHow would you like to proceed with this? I can raise a PR if required.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/shap/shap/issues/608/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/shap/shap/issues/608/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
