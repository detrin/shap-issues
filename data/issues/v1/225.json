{
  "url": "https://api.github.com/repos/shap/shap/issues/225",
  "repository_url": "https://api.github.com/repos/shap/shap",
  "labels_url": "https://api.github.com/repos/shap/shap/issues/225/labels{/name}",
  "comments_url": "https://api.github.com/repos/shap/shap/issues/225/comments",
  "events_url": "https://api.github.com/repos/shap/shap/issues/225/events",
  "html_url": "https://github.com/shap/shap/issues/225",
  "id": 351009408,
  "node_id": "MDU6SXNzdWUzNTEwMDk0MDg=",
  "number": 225,
  "title": "DeepExplainer instability on VGG16",
  "user": {
    "login": "slundberg",
    "id": 3740613,
    "node_id": "MDQ6VXNlcjM3NDA2MTM=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3740613?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/slundberg",
    "html_url": "https://github.com/slundberg",
    "followers_url": "https://api.github.com/users/slundberg/followers",
    "following_url": "https://api.github.com/users/slundberg/following{/other_user}",
    "gists_url": "https://api.github.com/users/slundberg/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/slundberg/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/slundberg/subscriptions",
    "organizations_url": "https://api.github.com/users/slundberg/orgs",
    "repos_url": "https://api.github.com/users/slundberg/repos",
    "events_url": "https://api.github.com/users/slundberg/events{/privacy}",
    "received_events_url": "https://api.github.com/users/slundberg/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2018-08-16T00:04:43Z",
  "updated_at": "2018-08-16T22:07:23Z",
  "closed_at": "2018-08-16T22:07:23Z",
  "author_association": "COLLABORATOR",
  "active_lock_reason": null,
  "body": "The code below shows a scenario where the SHAP values estimated by DeepExplainer don't sum up to the output of the model (which is an error). It seems to be specific to the mongoose image input, and I am opening this issue to track it until it is resolved.\r\n\r\n```python\r\nfrom keras.applications.vgg16 import VGG16\r\nfrom keras.applications.vgg16 import preprocess_input, decode_predictions\r\nimport numpy as np\r\nimport shap\r\nimport keras.backend as K\r\nimport json\r\n\r\n# load pre-trained model and choose two images to explain\r\nmodel = VGG16(weights='imagenet', include_top=True)\r\nX,y = shap.datasets.imagenet50()\r\nto_explain = X[[39,41]]\r\n\r\n# load the ImageNet class names\r\nurl = \"https://s3.amazonaws.com/deep-learning-models/image-models/imagenet_class_index.json\"\r\nfname = shap.datasets.cache(url)\r\nwith open(fname) as f:\r\n    class_names = json.load(f)\r\n\r\n# explain how the input to the 7th layer of the model explains the top two classes\r\ndef map2layer(x, layer):\r\n    feed_dict = dict(zip([model.layers[0].input], [preprocess_input(x.copy())]))\r\n    return K.get_session().run(model.layers[layer].input, feed_dict)\r\nmid_layer = 19\r\ne = shap.DeepExplainer((model.layers[mid_layer].input, model.layers[-1].output), map2layer(preprocess_input(X[:10].copy()), mid_layer))\r\nshap_values,indexes = e.shap_values(map2layer(to_explain[1:2], mid_layer), ranked_outputs=4)\r\n\r\nmodel_out = model.predict(preprocess_input(to_explain[1:2].copy()))[0,indexes[0]]\r\nshap_value_sums = np.array([shap_values[i].sum() for i in range(len(indexes[0]))])\r\nassert np.abs(shap_value_sums + e.expected_value[indexes[0]] - model_out).sum() < 1e-2\r\n```",
  "closed_by": {
    "login": "slundberg",
    "id": 3740613,
    "node_id": "MDQ6VXNlcjM3NDA2MTM=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3740613?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/slundberg",
    "html_url": "https://github.com/slundberg",
    "followers_url": "https://api.github.com/users/slundberg/followers",
    "following_url": "https://api.github.com/users/slundberg/following{/other_user}",
    "gists_url": "https://api.github.com/users/slundberg/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/slundberg/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/slundberg/subscriptions",
    "organizations_url": "https://api.github.com/users/slundberg/orgs",
    "repos_url": "https://api.github.com/users/slundberg/repos",
    "events_url": "https://api.github.com/users/slundberg/events{/privacy}",
    "received_events_url": "https://api.github.com/users/slundberg/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/shap/shap/issues/225/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/shap/shap/issues/225/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
