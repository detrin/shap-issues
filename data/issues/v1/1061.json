{
  "url": "https://api.github.com/repos/shap/shap/issues/1061",
  "repository_url": "https://api.github.com/repos/shap/shap",
  "labels_url": "https://api.github.com/repos/shap/shap/issues/1061/labels{/name}",
  "comments_url": "https://api.github.com/repos/shap/shap/issues/1061/comments",
  "events_url": "https://api.github.com/repos/shap/shap/issues/1061/events",
  "html_url": "https://github.com/shap/shap/issues/1061",
  "id": 569011402,
  "node_id": "MDU6SXNzdWU1NjkwMTE0MDI=",
  "number": 1061,
  "title": "shap.TreeExplainer fails when CatBoost has a categorical feature.",
  "user": {
    "login": "arose13",
    "id": 3430249,
    "node_id": "MDQ6VXNlcjM0MzAyNDk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3430249?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/arose13",
    "html_url": "https://github.com/arose13",
    "followers_url": "https://api.github.com/users/arose13/followers",
    "following_url": "https://api.github.com/users/arose13/following{/other_user}",
    "gists_url": "https://api.github.com/users/arose13/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/arose13/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/arose13/subscriptions",
    "organizations_url": "https://api.github.com/users/arose13/orgs",
    "repos_url": "https://api.github.com/users/arose13/repos",
    "events_url": "https://api.github.com/users/arose13/events{/privacy}",
    "received_events_url": "https://api.github.com/users/arose13/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2020-02-21T15:09:00Z",
  "updated_at": "2020-02-21T17:48:19Z",
  "closed_at": "2020-02-21T17:47:05Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "Shapley isn't working for some reason and I'm getting incredibly obscure errors. Even though CatBoost is throwing the error it must be because of shap as the CatBoost models still work when called directly. I think the problem is because shap calls `get_feature_importance()` with a deprecated argument.\r\n\r\nThe error is\r\n```python\r\nTraceback (most recent call last):\r\n  File \"C:/Users/antho/.PyCharm2019.3/config/scratches/scratch_5.py\", line 17, in <module>\r\n    shap_values = explainer.shap_values(x)\r\n  File \"C:\\Users\\antho\\Miniconda3\\lib\\site-packages\\shap\\explainers\\tree.py\", line 247, in shap_values\r\n    phi = self.model.original_model.get_feature_importance(data=X, fstr_type='ShapValues')\r\n  File \"C:\\Users\\antho\\Miniconda3\\lib\\site-packages\\catboost\\core.py\", line 2322, in get_feature_importance\r\n    fstr, feature_names = self._calc_fstr(type, data, thread_count, verbose, shap_mode)\r\n  File \"C:\\Users\\antho\\Miniconda3\\lib\\site-packages\\catboost\\core.py\", line 1287, in _calc_fstr\r\n    return self._object._calc_fstr(type.name, pool, thread_count, verbose, shap_mode)\r\n  File \"_catboost.pyx\", line 4084, in _catboost._CatBoost._calc_fstr\r\n  File \"_catboost.pyx\", line 4114, in _catboost._CatBoost._calc_fstr\r\n_catboost.CatBoostError: c:/goagent/pipelines/buildmaster/catboost.git/catboost/libs/data/model_dataset_compatibility.cpp:47: Feature CHAS is Categorical in model but marked different in the dataset\r\n\r\nProcess finished with exit code 1\r\n```\r\n\r\nit's probably due to calling a deprecated argument `fstr_type='ShapValues'`...\r\n```python\r\nFile \"C:\\Users\\antho\\Miniconda3\\lib\\site-packages\\shap\\explainers\\tree.py\", line 247, in shap_values\r\n    phi = self.model.original_model.get_feature_importance(data=X, fstr_type='ShapValues')\r\n```\r\n\r\nThe code required to get this error\r\n```python\r\nimport shap\r\nimport pandas as pd\r\nfrom catboost import CatBoostRegressor\r\nfrom sklearn.datasets import load_boston\r\n\r\nbunch = load_boston()\r\nx, y = load_boston(True)\r\nx = pd.DataFrame(x, columns=bunch.feature_names)\r\nx['CHAS'] = x['CHAS'].astype(str)\r\nprint(x)\r\n\r\nmodel = CatBoostRegressor(1000, cat_features=['CHAS'], verbose=False)\r\nmodel.fit(x, y)\r\n\r\nif __name__ == '__main__':\r\n    explainer = shap.TreeExplainer(model)\r\n    shap_values = explainer.shap_values(x)\r\n\r\n```",
  "closed_by": {
    "login": "slundberg",
    "id": 3740613,
    "node_id": "MDQ6VXNlcjM3NDA2MTM=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3740613?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/slundberg",
    "html_url": "https://github.com/slundberg",
    "followers_url": "https://api.github.com/users/slundberg/followers",
    "following_url": "https://api.github.com/users/slundberg/following{/other_user}",
    "gists_url": "https://api.github.com/users/slundberg/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/slundberg/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/slundberg/subscriptions",
    "organizations_url": "https://api.github.com/users/slundberg/orgs",
    "repos_url": "https://api.github.com/users/slundberg/repos",
    "events_url": "https://api.github.com/users/slundberg/events{/privacy}",
    "received_events_url": "https://api.github.com/users/slundberg/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/shap/shap/issues/1061/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/shap/shap/issues/1061/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
