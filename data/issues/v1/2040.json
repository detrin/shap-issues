{
  "url": "https://api.github.com/repos/shap/shap/issues/2040",
  "repository_url": "https://api.github.com/repos/shap/shap",
  "labels_url": "https://api.github.com/repos/shap/shap/issues/2040/labels{/name}",
  "comments_url": "https://api.github.com/repos/shap/shap/issues/2040/comments",
  "events_url": "https://api.github.com/repos/shap/shap/issues/2040/events",
  "html_url": "https://github.com/shap/shap/issues/2040",
  "id": 917990253,
  "node_id": "MDU6SXNzdWU5MTc5OTAyNTM=",
  "number": 2040,
  "title": "Error with 3D input on shap.DeepExplainer (pytorch model)",
  "user": {
    "login": "Jhonathan-Pedroso",
    "id": 14352527,
    "node_id": "MDQ6VXNlcjE0MzUyNTI3",
    "avatar_url": "https://avatars.githubusercontent.com/u/14352527?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Jhonathan-Pedroso",
    "html_url": "https://github.com/Jhonathan-Pedroso",
    "followers_url": "https://api.github.com/users/Jhonathan-Pedroso/followers",
    "following_url": "https://api.github.com/users/Jhonathan-Pedroso/following{/other_user}",
    "gists_url": "https://api.github.com/users/Jhonathan-Pedroso/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Jhonathan-Pedroso/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Jhonathan-Pedroso/subscriptions",
    "organizations_url": "https://api.github.com/users/Jhonathan-Pedroso/orgs",
    "repos_url": "https://api.github.com/users/Jhonathan-Pedroso/repos",
    "events_url": "https://api.github.com/users/Jhonathan-Pedroso/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Jhonathan-Pedroso/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 3,
  "created_at": "2021-06-10T22:13:20Z",
  "updated_at": "2022-04-21T07:35:13Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "I have been trying to use the `shap.DeepExplainer` with a `self-attention residual convolutional neural network` (implemented in `pytorch`) using a `3D input` (example, feature, time) - the model perform 1D convolution over time;\r\n\r\nI can initiate just fine the `shap.DeepExplainer`:\r\n\r\n``` python\r\ne = shap.DeepExplainer(model, background)\r\n```\r\n\r\nbut when I try to apply it to get the shap values:\r\n\r\n``` python\r\ne.shap_values(examples)\r\n```\r\nI get the following error:\r\n``` python\r\n---------------------------------------------------------------------------\r\nRuntimeError                              Traceback (most recent call last)\r\n<ipython-input-91-138564fb42cf> in <module>\r\n----> 1 e.shap_values(examples)\r\n\r\n~/anaconda3/envs/pyro/lib/python3.8/site-packages/shap/explainers/_deep/__init__.py in shap_values(self, X, ranked_outputs, output_rank_order, check_additivity)\r\n    122             were chosen as \"top\".\r\n    123         \"\"\"\r\n--> 124         return self.explainer.shap_values(X, ranked_outputs, output_rank_order, check_additivity=check_additivity)\r\n\r\n~/anaconda3/envs/pyro/lib/python3.8/site-packages/shap/explainers/_deep/deep_pytorch.py in shap_values(self, X, ranked_outputs, output_rank_order, check_additivity)\r\n    183                 # run attribution computation graph\r\n    184                 feature_ind = model_output_ranks[j, i]\r\n--> 185                 sample_phis = self.gradient(feature_ind, joint_x)\r\n    186                 # assign the attributions to the right part of the output arrays\r\n    187                 if self.interim:\r\n\r\n~/anaconda3/envs/pyro/lib/python3.8/site-packages/shap/explainers/_deep/deep_pytorch.py in gradient(self, idx, inputs)\r\n    119         else:\r\n    120             for idx, x in enumerate(X):\r\n--> 121                 grad = torch.autograd.grad(selected, x,\r\n    122                                            retain_graph=True if idx + 1 < len(X) else None,\r\n    123                                            allow_unused=True)[0]\r\n\r\n~/anaconda3/envs/pyro/lib/python3.8/site-packages/torch/autograd/__init__.py in grad(outputs, inputs, grad_outputs, retain_graph, create_graph, only_inputs, allow_unused)\r\n    200         retain_graph = create_graph\r\n    201 \r\n--> 202     return Variable._execution_engine.run_backward(\r\n    203         outputs, grad_outputs_, retain_graph, create_graph,\r\n    204         inputs, allow_unused)\r\n\r\n~/anaconda3/envs/pyro/lib/python3.8/site-packages/shap/explainers/_deep/deep_pytorch.py in deeplift_grad(module, grad_input, grad_output)\r\n    224     if module_type in op_handler:\r\n    225         if op_handler[module_type].__name__ not in ['passthrough', 'linear_1d']:\r\n--> 226             return op_handler[module_type](module, grad_input, grad_output)\r\n    227     else:\r\n    228         print('Warning: unrecognized nn.Module: {}'.format(module_type))\r\n\r\n~/anaconda3/envs/pyro/lib/python3.8/site-packages/shap/explainers/_deep/deep_pytorch.py in nonlinear_1d(module, grad_input, grad_output)\r\n    356     grads = [None for _ in grad_input]\r\n    357     grads[0] = torch.where(torch.abs(delta_in.repeat(dup0)) < 1e-6, grad_input[0],\r\n--> 358                            grad_output[0] * (delta_out / delta_in).repeat(dup0))\r\n    359     return tuple(grads)\r\n    360 \r\n\r\nRuntimeError: The size of tensor a (27) must match the size of tensor b (14) at non-singleton dimension 2\r\n```\r\n\r\nThe CNN model work just fine for prediction. It seems a problem systematic to the shap library. Any help would be highly appretiated.\r\n\r\nThank you in advance!\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/shap/shap/issues/2040/reactions",
    "total_count": 2,
    "+1": 2,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/shap/shap/issues/2040/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
