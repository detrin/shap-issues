{
  "url": "https://api.github.com/repos/shap/shap/issues/1126",
  "repository_url": "https://api.github.com/repos/shap/shap",
  "labels_url": "https://api.github.com/repos/shap/shap/issues/1126/labels{/name}",
  "comments_url": "https://api.github.com/repos/shap/shap/issues/1126/comments",
  "events_url": "https://api.github.com/repos/shap/shap/issues/1126/events",
  "html_url": "https://github.com/shap/shap/issues/1126",
  "id": 592043844,
  "node_id": "MDU6SXNzdWU1OTIwNDM4NDQ=",
  "number": 1126,
  "title": "DeepExplainer: shap_values containing \"nan\" values",
  "user": {
    "login": "FrederickDeny",
    "id": 59290237,
    "node_id": "MDQ6VXNlcjU5MjkwMjM3",
    "avatar_url": "https://avatars.githubusercontent.com/u/59290237?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/FrederickDeny",
    "html_url": "https://github.com/FrederickDeny",
    "followers_url": "https://api.github.com/users/FrederickDeny/followers",
    "following_url": "https://api.github.com/users/FrederickDeny/following{/other_user}",
    "gists_url": "https://api.github.com/users/FrederickDeny/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/FrederickDeny/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/FrederickDeny/subscriptions",
    "organizations_url": "https://api.github.com/users/FrederickDeny/orgs",
    "repos_url": "https://api.github.com/users/FrederickDeny/repos",
    "events_url": "https://api.github.com/users/FrederickDeny/events{/privacy}",
    "received_events_url": "https://api.github.com/users/FrederickDeny/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2020-04-01T16:25:05Z",
  "updated_at": "2020-06-05T15:09:01Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "Hello, I have an issue with my shap values, here is my model:\r\n```\r\nModel: \"model_3\"\r\n__________________________________________________________________________________________________\r\nLayer (type)                    Output Shape         Param #     Connected to                     \r\n==================================================================================================\r\ninput_4 (InputLayer)            [(None, 158)]        0                                            \r\n__________________________________________________________________________________________________\r\nmodel_1 (Model)                 (None, 158)          57310       input_4[0][0]                    \r\n__________________________________________________________________________________________________\r\nsubtract_3 (Subtract)           (None, 158)          0           input_4[0][0]                    \r\n                                                                 model_1[4][0]                    \r\n__________________________________________________________________________________________________\r\nmultiply_3 (Multiply)           (None, 158)          0           subtract_3[0][0]                 \r\n                                                                 subtract_3[0][0]                 \r\n__________________________________________________________________________________________________\r\nlambda_3 (Lambda)               (None,)              0           multiply_3[0][0]                 \r\n==================================================================================================\r\nTotal params: 57,310\r\nTrainable params: 57,310\r\nNon-trainable params: 0\r\n__________________________________________________________________________________________________\r\n```\r\nAnd I call : \r\n\r\n```\r\nscores = new_model.predict(X_test_scaled)\r\nscores = scores.reshape(scores.shape[0],1)\r\ntoexplain = np.append(X_test_scaled, scores, axis = 1)\r\ntoexplain = pd.DataFrame(toexplain)\r\ntoexplain.sort_values(by = [158], ascending=False, inplace=True)\r\ntoexplain = toexplain.iloc[0:16]\r\ntoexplain.drop(columns = [158], axis = 1, inplace = True)\r\n\r\nexplainer=shap.DeepExplainer(new_model, df_sampled_X_train_scaled)\r\nshap_values = explainer.shap_values(toexplain, check_additivity=False)\r\n```\r\n\r\nBut my shap values look like this (for the first instance):\r\n```\r\nshap_values[0]\r\n\r\narray([        nan,         nan,         nan,  0.08352888,         nan,\r\n               nan,         nan,         nan,         nan,         nan,\r\n               nan,         nan,         nan,         nan,         nan,\r\n               nan,         nan,         nan,         nan,         nan,\r\n               nan,         nan,         nan,         nan,  0.03286453,\r\n               nan,         nan,  0.2984612 ,         nan,         nan,\r\n               nan,  0.01110088, -0.85235232,         nan,         nan,\r\n               nan,         nan,         nan,         nan, -0.27935541,\r\n               nan,         nan,         nan,         nan,         nan,\r\n               nan,         nan, -0.18422949,  0.01466912,         nan,\r\n               nan,         nan, -0.1688329 ,  0.07462809,  0.03071906,\r\n               nan, -0.00554245,         nan,         nan,         nan,\r\n               nan,  0.04587848,         nan,         nan,         nan,\r\n               nan,  0.05448143,         nan,         nan,         nan,\r\n               nan,         nan,         nan,         nan,         nan,\r\n               nan,         nan,         nan,         nan,         nan,\r\n               nan,         nan,         nan,         nan,         nan,\r\n               nan,         nan,         nan,         nan,         nan,\r\n               nan,  0.00933742,         nan,         nan,         nan,\r\n               nan,         nan,         nan,         nan,         nan,\r\n               nan,         nan,  0.00919492,         nan,         nan,\r\n               nan,         nan,         nan,         nan,         nan,\r\n               nan,         nan,         nan,         nan,         nan,\r\n               nan,         nan,         nan,         nan,         nan,\r\n               nan,         nan,         nan,         nan,         nan,\r\n               nan,         nan,         nan,         nan,         nan,\r\n               nan,         nan,         nan,         nan,         nan,\r\n               nan,         nan,         nan,         nan,         nan,\r\n               nan,         nan,         nan,         nan,         nan,\r\n               nan,         nan,         nan,         nan,         nan,\r\n               nan,         nan,         nan,         nan,         nan,\r\n               nan,         nan,         nan])\r\n\r\n```\r\n\r\nI'm fairly certain I'm not supposed to have nan values among my shap_values, but I can't seem to find the original issue.\r\nMoreover, the predicted values given by the `shap.force_plot` is different than my model's predictions, which is why I checked my shap_values in the first place.\r\n\r\n\r\n\r\nAnother issue that may be linked is the fact that without `check_additivity=False`, I get this error:\r\n```\r\n---------------------------------------------------------------------------\r\nTypeError                                 Traceback (most recent call last)\r\n<ipython-input-75-a4ac5b901f4d> in <module>\r\n----> 1 shap_values = explainer.shap_values(toexplain)\r\n\r\n/usr/local/lib/python3.6/dist-packages/shap/explainers/deep/__init__.py in shap_values(self, X, ranked_outputs, output_rank_order, check_additivity)\r\n    117         were chosen as \"top\".\r\n    118         \"\"\"\r\n--> 119         return self.explainer.shap_values(X, ranked_outputs, output_rank_order, check_additivity=check_additivity)\r\n\r\n/usr/local/lib/python3.6/dist-packages/shap/explainers/deep/deep_tf.py in shap_values(self, X, ranked_outputs, output_rank_order, check_additivity)\r\n    316             else:\r\n    317                 model_output = self.model(X)\r\n--> 318             for l in range(len(self.expected_value)):\r\n    319                 if not self.multi_input:\r\n    320                     diffs = model_output[:, l] - self.expected_value[l] - output_phis[l].sum(axis=tuple(range(1, output_phis[l].ndim)))\r\n\r\nTypeError: object of type 'numpy.float32' has no len()\r\n```\r\n\r\neventhought I suppose that `expected_value` shouln't be a list, as my model isn't a multi-ouput one.\r\n",
  "closed_by": {
    "login": "FrederickDeny",
    "id": 59290237,
    "node_id": "MDQ6VXNlcjU5MjkwMjM3",
    "avatar_url": "https://avatars.githubusercontent.com/u/59290237?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/FrederickDeny",
    "html_url": "https://github.com/FrederickDeny",
    "followers_url": "https://api.github.com/users/FrederickDeny/followers",
    "following_url": "https://api.github.com/users/FrederickDeny/following{/other_user}",
    "gists_url": "https://api.github.com/users/FrederickDeny/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/FrederickDeny/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/FrederickDeny/subscriptions",
    "organizations_url": "https://api.github.com/users/FrederickDeny/orgs",
    "repos_url": "https://api.github.com/users/FrederickDeny/repos",
    "events_url": "https://api.github.com/users/FrederickDeny/events{/privacy}",
    "received_events_url": "https://api.github.com/users/FrederickDeny/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/shap/shap/issues/1126/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/shap/shap/issues/1126/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
