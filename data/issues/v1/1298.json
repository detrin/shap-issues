{
  "url": "https://api.github.com/repos/shap/shap/issues/1298",
  "repository_url": "https://api.github.com/repos/shap/shap",
  "labels_url": "https://api.github.com/repos/shap/shap/issues/1298/labels{/name}",
  "comments_url": "https://api.github.com/repos/shap/shap/issues/1298/comments",
  "events_url": "https://api.github.com/repos/shap/shap/issues/1298/events",
  "html_url": "https://github.com/shap/shap/issues/1298",
  "id": 650869481,
  "node_id": "MDU6SXNzdWU2NTA4Njk0ODE=",
  "number": 1298,
  "title": "shap.common.SHAPError: Additivity check failed in TreeExplainer! is thrown sometimes",
  "user": {
    "login": "giancarloGiuffra",
    "id": 4750755,
    "node_id": "MDQ6VXNlcjQ3NTA3NTU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4750755?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/giancarloGiuffra",
    "html_url": "https://github.com/giancarloGiuffra",
    "followers_url": "https://api.github.com/users/giancarloGiuffra/followers",
    "following_url": "https://api.github.com/users/giancarloGiuffra/following{/other_user}",
    "gists_url": "https://api.github.com/users/giancarloGiuffra/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/giancarloGiuffra/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/giancarloGiuffra/subscriptions",
    "organizations_url": "https://api.github.com/users/giancarloGiuffra/orgs",
    "repos_url": "https://api.github.com/users/giancarloGiuffra/repos",
    "events_url": "https://api.github.com/users/giancarloGiuffra/events{/privacy}",
    "received_events_url": "https://api.github.com/users/giancarloGiuffra/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2020-07-04T10:42:31Z",
  "updated_at": "2021-01-06T17:36:58Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "Hi, I have set up a simple example with the sklearn.ensemble.RandomForestClassifier. When I run it, sometimes it throws the error mentioned in the title. The code is the following:\r\n\r\n```python\r\nfrom sklearn.model_selection import train_test_split\r\nfrom sklearn.ensemble import RandomForestClassifier\r\nimport shap\r\n\r\nX, y = shap.datasets.adult()\r\n\r\nX_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=7)\r\nprint('training model...')\r\nmodel = RandomForestClassifier(n_estimators=5, max_depth=10, random_state=7)\r\nmodel.fit(X_train, y_train)\r\nprint('...done')\r\n\r\nprint('shap values...')\r\nexplainer = shap.TreeExplainer(model)\r\nshap_values = explainer.shap_values(X)\r\nprint('...done')\r\n```\r\n\r\nThe complete error is:\r\n```\r\nTraceback (most recent call last):\r\n  File \"/Users/gianca/shap/main.py\", line 17, in <module>\r\n    shap_values = explainer.shap_values(X)\r\n  File \"/Users/gianca/shap/venv/lib/python3.7/site-packages/shap/explainers/tree.py\", line 344, in shap_values\r\n    self.assert_additivity(out, self.model.predict(X))\r\n  File \"/Users/gianca/shap/venv/lib/python3.7/site-packages/shap/explainers/tree.py\", line 467, in assert_additivity\r\n    check_sum(self.expected_value[i] + phi[i].sum(-1), model_output[:,i])\r\n  File \"/Users/gianca/shap/venv/lib/python3.7/site-packages/shap/explainers/tree.py\", line 463, in check_sum\r\n    raise SHAPError(err_msg)\r\nshap.common.SHAPError: Additivity check failed in TreeExplainer! Please ensure the data matrix you passed to the explainer is the same shape that the model was trained on. If your data shape is correct then please report this on GitHub. Consider retrying with the feature_perturbation='interventional' option. This check failed because for one of the samples the sum of the SHAP values was 0.116977, while the model output was 231584178474632390847141970017375815706539969331281128078915168015826259279872.000000. If this difference is acceptable you can set check_additivity=False to disable this check.\r\n```\r\nTwo notes:\r\n1. Why the error reports a value that can certainly not be the model output? `This check failed because for one of the samples the sum of the SHAP values was 0.116977, while the model output was 231584178474632390847141970017375815706539969331281128078915168015826259279872.000000.`\r\n2. I have run the same exact script and sometimes it does not throw the error, other times it throws it with a different a different value for the model output.\r\n\r\nI suppose randomness is used in the calculation of the shap_values, right? Otherwise I cannot explain this behavior.\r\n\r\nI am using a Macbook Pro 2014, 2.6GHz  Intel Core i5 dual core, RAM 8 GB 1600 MHz DDR3. Operating System Catalina.\r\n\r\nI am happy to help, thanks.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/shap/shap/issues/1298/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/shap/shap/issues/1298/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
