{
  "url": "https://api.github.com/repos/shap/shap/issues/2014",
  "repository_url": "https://api.github.com/repos/shap/shap",
  "labels_url": "https://api.github.com/repos/shap/shap/issues/2014/labels{/name}",
  "comments_url": "https://api.github.com/repos/shap/shap/issues/2014/comments",
  "events_url": "https://api.github.com/repos/shap/shap/issues/2014/events",
  "html_url": "https://github.com/shap/shap/issues/2014",
  "id": 903312822,
  "node_id": "MDU6SXNzdWU5MDMzMTI4MjI=",
  "number": 2014,
  "title": "Speeding up partition_tree (O(n**2) -> O(n))",
  "user": {
    "login": "GillesVandewiele",
    "id": 5750603,
    "node_id": "MDQ6VXNlcjU3NTA2MDM=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5750603?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/GillesVandewiele",
    "html_url": "https://github.com/GillesVandewiele",
    "followers_url": "https://api.github.com/users/GillesVandewiele/followers",
    "following_url": "https://api.github.com/users/GillesVandewiele/following{/other_user}",
    "gists_url": "https://api.github.com/users/GillesVandewiele/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/GillesVandewiele/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/GillesVandewiele/subscriptions",
    "organizations_url": "https://api.github.com/users/GillesVandewiele/orgs",
    "repos_url": "https://api.github.com/users/GillesVandewiele/repos",
    "events_url": "https://api.github.com/users/GillesVandewiele/events{/privacy}",
    "received_events_url": "https://api.github.com/users/GillesVandewiele/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 0,
  "created_at": "2021-05-27T07:14:01Z",
  "updated_at": "2021-05-27T07:14:01Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "The current implementation of partition_tree has a quadratic complexity in function of the length of `decoded_tokens`. This is due to this line: https://github.com/slundberg/shap/blob/master/shap/maskers/_text.py#L444 where all scores for each element are re-calculated. However, only minimal changes occurred in comparison to last iteration so many calculations are done redundantly.\r\n\r\nA solution, which makes the complexity linear instead of quadratic, is to only update the scores of the relevant parts (i.e. the ones that changed):\r\n\r\n```python3\r\ndef partition_tree(decoded_tokens, special_tokens=None):\r\n    .\r\n    .\r\n    .\r\n    scores = [shap.maskers._text.merge_score(token_groups[i], token_groups[i + 1], special_tokens)\r\n              for i in range(len(token_groups) - 1)]\r\n    for i in range(N):\r\n        .\r\n        .\r\n        .\r\n        if len(scores) > 3 and 0 < ind < len(token_groups) - 1:\r\n            score1 = shap.maskers._text.merge_score(token_groups[ind - 1], token_groups[ind], special_tokens)\r\n            score2 = shap.maskers._text.merge_score(token_groups[ind], token_groups[ind + 1], special_tokens)\r\n            scores = scores[:ind - 1] + [score1, score2] + scores[ind + 2:]\r\n        else:\r\n            scores = [shap.maskers._text.merge_score(token_groups[i], token_groups[i + 1], special_tokens)\r\n                      for i in range(len(token_groups) - 1)]\r\n```\r\n\r\n**For a very long string (5881 characters and 882 tokens), this speeds up the explanation from 17 seconds to 2 seconds.**",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/shap/shap/issues/2014/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/shap/shap/issues/2014/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
