{
  "url": "https://api.github.com/repos/shap/shap/issues/2071",
  "repository_url": "https://api.github.com/repos/shap/shap",
  "labels_url": "https://api.github.com/repos/shap/shap/issues/2071/labels{/name}",
  "comments_url": "https://api.github.com/repos/shap/shap/issues/2071/comments",
  "events_url": "https://api.github.com/repos/shap/shap/issues/2071/events",
  "html_url": "https://github.com/shap/shap/issues/2071",
  "id": 935559110,
  "node_id": "MDU6SXNzdWU5MzU1NTkxMTA=",
  "number": 2071,
  "title": "shap multi class xgboost classifier issue",
  "user": {
    "login": "ssetty",
    "id": 18573526,
    "node_id": "MDQ6VXNlcjE4NTczNTI2",
    "avatar_url": "https://avatars.githubusercontent.com/u/18573526?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ssetty",
    "html_url": "https://github.com/ssetty",
    "followers_url": "https://api.github.com/users/ssetty/followers",
    "following_url": "https://api.github.com/users/ssetty/following{/other_user}",
    "gists_url": "https://api.github.com/users/ssetty/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ssetty/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ssetty/subscriptions",
    "organizations_url": "https://api.github.com/users/ssetty/orgs",
    "repos_url": "https://api.github.com/users/ssetty/repos",
    "events_url": "https://api.github.com/users/ssetty/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ssetty/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2021-07-02T08:49:33Z",
  "updated_at": "2021-07-19T21:30:07Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "Hello,\r\n\r\nI am unable to generate shap force plot for multi class xgboost classifier. Data has numerical and categorical factors. Kindly send correct code for  explainability of a single model prediction. Force plot can be used for error analysis, finding the explanation to specific instance prediction.\r\n\r\nBelow is sample code.\r\nimport pandas as pd \r\nimport numpy as np \r\n\r\nimport sklearn \r\nfrom sklearn.model_selection  import train_test_split \r\nfrom sklearn.linear_model import LogisticRegression\r\nfrom sklearn.preprocessing import LabelEncoder, OrdinalEncoder\r\n\r\n\r\nimport xgboost as xgb \r\nimport xgboost \r\n\r\nimport sklearn.ensemble\r\nimport sklearn as skl\r\n\r\n\r\n\r\nimport shap\r\nimport time \r\nimport os \r\nimport matplotlib.pyplot as plt\r\nimport seaborn as sns \r\n \r\nle = LabelEncoder()\r\ndf['target_col'] = le.fit_transform(df['target_col'])\r\nprint(le.classes_)\r\n\r\n\r\ny_sel = df['target_col'] \r\ncategorical_cols = x_sel.select_dtypes(include=['object']).columns.tolist()\r\nnumerical_cols = x_sel.select_dtypes(exclude=['object']).columns.tolist()\r\n\r\n\r\ncategorical_nan_value = 'NotAvailable'\r\nnumerical_nan_value = -1\r\n    \r\noes = {}\r\nfor cat in categorical_cols:\r\n    oes[cat] = OrdinalEncoder(handle_unknown=\"use_encoded_value\", unknown_value=-1)\r\n    x_sel[cat] = x_sel[cat].fillna(categorical_nan_value)\r\n    x_sel[cat] = oes[cat].fit_transform(x_sel[cat].values.reshape(-1, 1))\r\n\r\n\r\nfrom sklearn.preprocessing import StandardScaler\r\nscaler = StandardScaler()\r\nx_sel[numerical_cols] = scaler.fit_transform(x_sel[numerical_cols])\r\n\r\nx_sel_tr,x_sel_te,y_sel_tr,y_sel_te = train_test_split(x_sel,y_sel,test_size =.33,random_state=1)\r\n\r\nxgb_model = xgboost.XGBClassifier( objective='multi:softprob', num_class=8, n_estimators=1000)\r\nxgb_model.fit(x_sel_tr, y_sel_tr)\r\n\r\n\r\npredictions = xgb_model.predict(x_sel_te)\r\npredictions_proba=xgb_model.predict_proba(x_sel_te)\r\naccuracy=skl.metrics.accuracy_score(y_sel_te, predictions)\r\nprint(accuracy*100)\r\n\r\nexplainerXGB = shap.TreeExplainer(xgb_model)\r\nshap_values_XGB_test = explainerXGB.shap_values(x_sel_te)\r\nshap_values_XGB_train = explainerXGB.shap_values(x_sel_tr)\r\n \r\nprint(type(shap_values_XGB_test)) # output: <class 'list'>\r\nprint(type(shap_values_XGB_test[0])) # output: <class 'numpy.ndarray'>\r\nprint(len(shap_values_XGB_test)) # output: 3\r\n\r\nshap.initjs()\r\ni = 18\r\nshap.force_plot(explainerXGB.expected_value, shap_values_XGB_train[i], x_sel_te[i], feature_names = x_sel_te.cols)\r\n\r\nRegards\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/shap/shap/issues/2071/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/shap/shap/issues/2071/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
