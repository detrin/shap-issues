{
  "url": "https://api.github.com/repos/shap/shap/issues/2703",
  "repository_url": "https://api.github.com/repos/shap/shap",
  "labels_url": "https://api.github.com/repos/shap/shap/issues/2703/labels{/name}",
  "comments_url": "https://api.github.com/repos/shap/shap/issues/2703/comments",
  "events_url": "https://api.github.com/repos/shap/shap/issues/2703/events",
  "html_url": "https://github.com/shap/shap/issues/2703",
  "id": 1383453064,
  "node_id": "I_kwDOBHDcK85SddGI",
  "number": 2703,
  "title": "[BUG] Manually assigning feature_names modifies beeswarm and bar plots",
  "user": {
    "login": "CarlaFernandez",
    "id": 9136877,
    "node_id": "MDQ6VXNlcjkxMzY4Nzc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/9136877?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/CarlaFernandez",
    "html_url": "https://github.com/CarlaFernandez",
    "followers_url": "https://api.github.com/users/CarlaFernandez/followers",
    "following_url": "https://api.github.com/users/CarlaFernandez/following{/other_user}",
    "gists_url": "https://api.github.com/users/CarlaFernandez/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/CarlaFernandez/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/CarlaFernandez/subscriptions",
    "organizations_url": "https://api.github.com/users/CarlaFernandez/orgs",
    "repos_url": "https://api.github.com/users/CarlaFernandez/repos",
    "events_url": "https://api.github.com/users/CarlaFernandez/events{/privacy}",
    "received_events_url": "https://api.github.com/users/CarlaFernandez/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2022-09-23T08:18:20Z",
  "updated_at": "2022-09-26T07:13:25Z",
  "closed_at": "2022-09-26T07:13:25Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "I'm working with an explanation object which I obtained from a model with a **One-Hot encoder step**. \r\n\r\n**I'm working with the following versions:**\r\n- shap==0.41.0\r\n- scikit-learn==1.1.1\r\n\r\nTo obtain the shap explanation I did the following (it's a MWE, you can reproduce it):\r\n```python\r\nimport pandas as pd\r\nimport numpy as np\r\nimport numpy as np\r\nfrom sklearn import metrics\r\nfrom sklearn.model_selection import train_test_split\r\nfrom sklearn.metrics import precision_score, recall_score\r\nfrom sklearn.compose import ColumnTransformer\r\nfrom sklearn.preprocessing import OneHotEncoder, OrdinalEncoder\r\nfrom sklearn.pipeline import Pipeline\r\nfrom sklearn.ensemble import RandomForestClassifier\r\nimport shap\r\npd.options.display.max_columns = None\r\n\r\n# data obtained from https://www.kaggle.com/datasets/blastchar/telco-customer-churn\r\ndata = pd.read_csv(\"data.csv\")\r\ndata.loc[data[\"TotalCharges\"] == \" \", \"TotalCharges\"] = \"0\"\r\ndata[\"TotalCharges\"] = data[\"TotalCharges\"].astype(float)\r\n\r\nfor v in [\"Partner\", \"Dependents\", \"PhoneService\", \"PaperlessBilling\", \"Churn\"]:\r\n    data[v] = np.where(data[v] == \"Yes\", 1, 0)\r\ndata[\"gender\"] = np.where(data[\"gender\"] == \"Male\", 1, 0)\r\n\r\nX_train, X_test, y_train, y_test = train_test_split(\r\n    data.drop(columns=[\"customerID\", \"Churn\"]), \r\n    data[\"Churn\"], \r\n    test_size=0.2, \r\n    random_state=42\r\n)\r\n\r\nto_ohe = [\"MultipleLines\", \"InternetService\", \"OnlineSecurity\", \"OnlineBackup\", \r\n          \"DeviceProtection\", \"TechSupport\", \"StreamingTV\", \"StreamingMovies\", \r\n          \"Contract\", \"PaymentMethod\"]\r\nohe = OneHotEncoder(drop=\"first\", handle_unknown=\"ignore\")\r\ntransformer = ColumnTransformer(\r\n    transformers=[\r\n        (\"cat\", ohe, to_ohe),\r\n    ],\r\n    remainder=\"passthrough\",\r\n)\r\nrf = RandomForestClassifier(n_estimators=50, max_depth=6, random_state=42)\r\npipe = Pipeline([(\"transformer\", transformer), (\"clf\", rf)])\r\npipe.fit(X_train, y_train)\r\n\r\nexplainer = shap.Explainer(pipe.steps[-1][1], seed=42)\r\nexplanation = explainer(pipe.steps[0][1].transform(X_test))\r\n```\r\nIf you plot right here the beeswarm for probability=1, you get:\r\n```python\r\nshap.plots.beeswarm(explanation[:, :, 1])\r\n```\r\n![image](https://user-images.githubusercontent.com/9136877/191918198-d09af0f5-e010-4e14-a556-0f576d64c829.png)\r\nSo, in order to append the feature names to this plot, I did the following:\r\n```python\r\nfeature_names = pipe.steps[0][1].get_feature_names_out()\r\nexplanation.feature_names = feature_names\r\nshap.plots.beeswarm(explanation[:, :, 1])\r\n```\r\nYou can see that plotting the same explanation object, after manually modifying the feature_names attribute, we get a different result:\r\n![image](https://user-images.githubusercontent.com/9136877/191918431-2c39fb5c-3103-46ac-b347-ca620d77049d.png)\r\nwhich is not expected at all â˜¹. \r\nThe Shap values appear to be the same, but the features are not ordered the same way. This happens too using shap.plots.bar:\r\n![image](https://user-images.githubusercontent.com/9136877/191918664-a0869c91-0dee-4076-b947-85b86db39bb2.png)\r\n\r\nAny idea why this might be happening?",
  "closed_by": {
    "login": "CarlaFernandez",
    "id": 9136877,
    "node_id": "MDQ6VXNlcjkxMzY4Nzc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/9136877?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/CarlaFernandez",
    "html_url": "https://github.com/CarlaFernandez",
    "followers_url": "https://api.github.com/users/CarlaFernandez/followers",
    "following_url": "https://api.github.com/users/CarlaFernandez/following{/other_user}",
    "gists_url": "https://api.github.com/users/CarlaFernandez/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/CarlaFernandez/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/CarlaFernandez/subscriptions",
    "organizations_url": "https://api.github.com/users/CarlaFernandez/orgs",
    "repos_url": "https://api.github.com/users/CarlaFernandez/repos",
    "events_url": "https://api.github.com/users/CarlaFernandez/events{/privacy}",
    "received_events_url": "https://api.github.com/users/CarlaFernandez/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/shap/shap/issues/2703/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/shap/shap/issues/2703/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
