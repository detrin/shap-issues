{
  "url": "https://api.github.com/repos/shap/shap/issues/1948",
  "repository_url": "https://api.github.com/repos/shap/shap",
  "labels_url": "https://api.github.com/repos/shap/shap/issues/1948/labels{/name}",
  "comments_url": "https://api.github.com/repos/shap/shap/issues/1948/comments",
  "events_url": "https://api.github.com/repos/shap/shap/issues/1948/events",
  "html_url": "https://github.com/shap/shap/issues/1948",
  "id": 862916771,
  "node_id": "MDU6SXNzdWU4NjI5MTY3NzE=",
  "number": 1948,
  "title": "PermutationExplainer is currently inefficient (does not use backward permutation evaluation)",
  "user": {
    "login": "sander-sn",
    "id": 2262035,
    "node_id": "MDQ6VXNlcjIyNjIwMzU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2262035?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/sander-sn",
    "html_url": "https://github.com/sander-sn",
    "followers_url": "https://api.github.com/users/sander-sn/followers",
    "following_url": "https://api.github.com/users/sander-sn/following{/other_user}",
    "gists_url": "https://api.github.com/users/sander-sn/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/sander-sn/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/sander-sn/subscriptions",
    "organizations_url": "https://api.github.com/users/sander-sn/orgs",
    "repos_url": "https://api.github.com/users/sander-sn/repos",
    "events_url": "https://api.github.com/users/sander-sn/events{/privacy}",
    "received_events_url": "https://api.github.com/users/sander-sn/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 0,
  "created_at": "2021-04-20T15:05:46Z",
  "updated_at": "2021-08-03T20:13:51Z",
  "closed_at": "2021-08-03T20:13:51Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "## Issue \r\nThe PermutationExplainer masks a permutation of the features in both the forward and backward direction but uses only the output of the forward direction. \r\n\r\n## Impact\r\nThe PermutationExplainer evaluates the given model on both the forward and backward permutations but the output of the backward permutation is never used yielding an evaluation of the model of (up to) twice the amount of data needed and a potentially drastic slowdown of the model agnostic explainer.\r\n\r\n## Solution\r\nTo fix this, we need only change a few lines of code to include the result from the backward permutation when estimating the SHAP values. The resulting SHAP value estimates are better as we include effectively per cycle an additional approximation of the SHAP values from the background permutation (whereas prior to this change we would include the forward permutation twice).\r\n\r\n## Detailed Explanation\r\nLet’s say we run PermutationExplainer for a model with three features (X is the training data):\r\n\r\n`shap_values = PermutationExplainer(model.predict, X)(X).values`\r\n\r\nLet’s say the first permutation of the features is the original order, i.e., [1, 2, 3].\r\n\r\nThe model will be evaluated with the following masking of the three features:\r\n```\r\n[\r\n    [False, False, False],\r\n    [True, False, False],\r\n    [True, True, False],\r\n    [True, True, True],\r\n    [False, True, True],\r\n    [False, False, True],\r\n    [False, False, False]\r\n]\r\n```\r\nThis is reflected in the model outputs, i.e., the shape from outputs below is (7,):\r\n\r\nhttps://github.com/slundberg/shap/blob/9411b68e8057a6c6f3621765b89b24d82bee13d4/shap/explainers/_permutation.py#L99\r\n\r\nThe original code updates the SHAP values in the following way:\r\n\r\nhttps://github.com/slundberg/shap/blob/9411b68e8057a6c6f3621765b89b24d82bee13d4/shap/explainers/_permutation.py#L104-L108\r\n\r\nThe len(inds) is 3 such that the values in outputs[3+1:] are never used. Effectively, the code just adds the approximation of the SHAP values from the forward pass twice. To include the backward permutation, we need only include the last values in outputs in the second loop. We can confirm with the masking that is evaluated. The backwards permutation is:\r\n\r\n```\r\n[\r\n    [False, False, False],\r\n    [False, False, True],\r\n    [False, True, True],\r\n    [True, True, True]\r\n]\r\n```\r\n\r\nOr, using the outputs of the model:\r\n\r\n`outputs[len(fm):][::-1]`\r\n\r\nFrom this, we can approximate the SHAP values for the reversed (i.e., backward) permutation of the reversed indices, inds[::-1].\r\n\r\nThus, the code to update the SHAP value estimates should be:\r\n\r\n```\r\nforwards, backwards = outputs[:len(fm)+1], outputs[len(fm):][::-1]\r\nfor i, ind in enumerate(inds):\r\n    row_values[ind] += forwards[i + 1] - forwards[i]\r\nfor i, ind in enumerate(inds[::-1]):\r\n    row_values[ind] += backwards[i + 1] - backwards[i]\r\n```\r\n\r\nOf course, we could just take differences here (but I personally prefer the more expressive code):\r\n\r\n```\r\nforwards, backwards = outputs[:len(fm)+1], outputs[len(fm):][::-1]\r\nrow_values[inds] += np.diff(forwards)\r\nrow_values[inds[::-1]] += np.diff(backwards)\r\n```",
  "closed_by": {
    "login": "slundberg",
    "id": 3740613,
    "node_id": "MDQ6VXNlcjM3NDA2MTM=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3740613?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/slundberg",
    "html_url": "https://github.com/slundberg",
    "followers_url": "https://api.github.com/users/slundberg/followers",
    "following_url": "https://api.github.com/users/slundberg/following{/other_user}",
    "gists_url": "https://api.github.com/users/slundberg/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/slundberg/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/slundberg/subscriptions",
    "organizations_url": "https://api.github.com/users/slundberg/orgs",
    "repos_url": "https://api.github.com/users/slundberg/repos",
    "events_url": "https://api.github.com/users/slundberg/events{/privacy}",
    "received_events_url": "https://api.github.com/users/slundberg/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/shap/shap/issues/1948/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/shap/shap/issues/1948/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
