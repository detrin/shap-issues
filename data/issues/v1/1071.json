{
  "url": "https://api.github.com/repos/shap/shap/issues/1071",
  "repository_url": "https://api.github.com/repos/shap/shap",
  "labels_url": "https://api.github.com/repos/shap/shap/issues/1071/labels{/name}",
  "comments_url": "https://api.github.com/repos/shap/shap/issues/1071/comments",
  "events_url": "https://api.github.com/repos/shap/shap/issues/1071/events",
  "html_url": "https://github.com/shap/shap/issues/1071",
  "id": 572072622,
  "node_id": "MDU6SXNzdWU1NzIwNzI2MjI=",
  "number": 1071,
  "title": "TreeExplainer failing additivity check by huge margin randomly",
  "user": {
    "login": "FRUEHNI1",
    "id": 40830407,
    "node_id": "MDQ6VXNlcjQwODMwNDA3",
    "avatar_url": "https://avatars.githubusercontent.com/u/40830407?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/FRUEHNI1",
    "html_url": "https://github.com/FRUEHNI1",
    "followers_url": "https://api.github.com/users/FRUEHNI1/followers",
    "following_url": "https://api.github.com/users/FRUEHNI1/following{/other_user}",
    "gists_url": "https://api.github.com/users/FRUEHNI1/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/FRUEHNI1/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/FRUEHNI1/subscriptions",
    "organizations_url": "https://api.github.com/users/FRUEHNI1/orgs",
    "repos_url": "https://api.github.com/users/FRUEHNI1/repos",
    "events_url": "https://api.github.com/users/FRUEHNI1/events{/privacy}",
    "received_events_url": "https://api.github.com/users/FRUEHNI1/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 10,
  "created_at": "2020-02-27T13:08:32Z",
  "updated_at": "2020-08-19T16:42:23Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "SHAP~HEAD\r\n\r\n- This issue ONLY arises for certain random datasets (e.g. if we change the seed sometimes it works!)\r\n- Additionally, if we comment out the model.predict_proba() step, there is also no error!!\r\n\r\n```python\r\n\r\nimport numpy as np\r\nimport pandas as pd\r\nimport shap\r\nfrom sklearn.ensemble import RandomForestClassifier\r\n\r\nnp.random.seed(7)\r\nx = pd.DataFrame(\r\n    {\r\n        \"A\": pd.Series(np.random.choice([1, 2, 3], size=(100,))),\r\n        \"B\": np.random.random(size=(100,)),\r\n        \"C\": np.random.random(size=(100,)),\r\n    }\r\n)\r\ny = x.A.astype(int).multiply(x.B)\r\ny = y.map(lambda zz: chr(int(zz * 2 + 65)))\r\n\r\nfor model in [RandomForestClassifier(n_estimators=5)]:\r\n    model.fit(x, y)\r\n    print(model.predict_proba(x))\r\n    exp = shap.TreeExplainer(model, x)\r\n    exp.shap_values(x)\r\n```\r\n\r\nleads to\r\n\r\nshap.common.SHAPError: Additivity check failed in TreeExplainer! Please ensure the data matrix you passed to the explainer is the same shape that the model was trained on. If your data shape is correct then please report this on GitHub. This check failed because for one of the samples the sum of the SHAP values was 1.000000, while the model output was 3111097975746974213687308567622027182957608232690168701852123934664961333470934833729588734056417829262788981086701226316001171507896865278576065971001727090611073033754656928361264433933354371027931366218874733058930961043226099712.000000. If this difference is acceptable you can set check_additivity=False to disable this check.",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/shap/shap/issues/1071/reactions",
    "total_count": 7,
    "+1": 7,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/shap/shap/issues/1071/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
