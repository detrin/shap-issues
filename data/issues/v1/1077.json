{
  "url": "https://api.github.com/repos/shap/shap/issues/1077",
  "repository_url": "https://api.github.com/repos/shap/shap",
  "labels_url": "https://api.github.com/repos/shap/shap/issues/1077/labels{/name}",
  "comments_url": "https://api.github.com/repos/shap/shap/issues/1077/comments",
  "events_url": "https://api.github.com/repos/shap/shap/issues/1077/events",
  "html_url": "https://github.com/shap/shap/issues/1077",
  "id": 573834359,
  "node_id": "MDU6SXNzdWU1NzM4MzQzNTk=",
  "number": 1077,
  "title": "ValueError: Operation 'switched_dropout_3/dropout/mul_1' has no attr named '_XlaCompile'.",
  "user": {
    "login": "tobiasharren",
    "id": 49845179,
    "node_id": "MDQ6VXNlcjQ5ODQ1MTc5",
    "avatar_url": "https://avatars.githubusercontent.com/u/49845179?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tobiasharren",
    "html_url": "https://github.com/tobiasharren",
    "followers_url": "https://api.github.com/users/tobiasharren/followers",
    "following_url": "https://api.github.com/users/tobiasharren/following{/other_user}",
    "gists_url": "https://api.github.com/users/tobiasharren/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tobiasharren/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tobiasharren/subscriptions",
    "organizations_url": "https://api.github.com/users/tobiasharren/orgs",
    "repos_url": "https://api.github.com/users/tobiasharren/repos",
    "events_url": "https://api.github.com/users/tobiasharren/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tobiasharren/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2020-03-02T09:26:32Z",
  "updated_at": "2020-07-24T15:22:55Z",
  "closed_at": "2020-07-24T15:22:55Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "Hello,\r\n\r\nI am having a bit of trouble with both the DeepExplainer and the GradientExplainer. I think I know roughly what the problem is, but I can't seem to find out how to fix it.\r\n\r\nI use a MultitaskRegressor Model from Deepchem (based on Keras), which consists of the following layers:\r\n[<tensorflow.python.keras.engine.input_layer.InputLayer object at 0x7efc92f7fb38>, <tensorflow.python.keras.layers.core.Dense object at 0x7efc92f7f390>, <tensorflow.python.keras.engine.input_layer.InputLayer object at 0x7efcd66d9908>, <deepchem.models.layers.SwitchedDropout object at 0x7efc92f7ff28>, <tensorflow.python.keras.layers.core.Dense object at 0x7efc92f340f0>, <deepchem.models.layers.SwitchedDropout object at 0x7efc92f440b8>, <tensorflow.python.keras.layers.core.Dense object at 0x7efc92efdb70>, <deepchem.models.layers.SwitchedDropout object at 0x7efc92f44438>, <tensorflow.python.keras.layers.core.Dense object at 0x7efc92ede9b0>, <deepchem.models.layers.SwitchedDropout object at 0x7efc92f44da0>, <tensorflow.python.keras.layers.core.Dense object at 0x7efc92e81a58>, <tensorflow.python.keras.layers.core.Reshape object at 0x7efc92f7fdd8>]\r\n\r\nI added a new reshape layer on top, so the output has only one dimension (I only have one output, so thats ok)\r\nI also checked that my inputs have the right format, so the call to session.run in deep_tf will be correctly executed and returns the expected values\r\n\r\noutput = tf.reshape(self.model.model.output, [-1, 1])\r\n\r\n(the strange notations are due to deepchems and my classes)\r\n\r\n\r\nThe problem lies probably with this SwitchedDropout Layer.\r\nThe Deepchem Definition is: \r\n\r\nclass SwitchedDropout(tf.keras.layers.Layer):\r\n  \"\"\"Apply dropout based on an input.\r\n\r\n  This is required for uncertainty prediction.  The standard Keras Dropout\r\n  layer only performs dropout during training, but we sometimes need to do it\r\n  during prediction.  The second input to this layer should be a scalar equal to\r\n  0 or 1, indicating whether to perform dropout.\r\n  \"\"\"\r\n\r\n  def __init__(self, rate, **kwargs):\r\n    self.rate = rate\r\n    super(SwitchedDropout, self).__init__(**kwargs)\r\n\r\n  def call(self, inputs):\r\n    rate = self.rate * tf.squeeze(inputs[1])\r\n    return tf.nn.dropout(inputs[0], rate=rate)\r\n\r\n\r\nI can build the DeepExplainer/GradientExplainer without issue, but when I try to get the shap values I get the following error message:\r\n\r\n  File \"/EXT/Tobha/.conda/envs/test_BA_Tobias_std_deepchem-2-3-0_py36_20200114/lib/python3.6/site-packages/tensorflow/python/framework/ops.py\", line 2639, in get_attr\r\n    c_api.TF_OperationGetAttrValueProto(self._c_op, name, buf)\r\ntensorflow.python.framework.errors_impl.InvalidArgumentError: Operation 'switched_dropout_3/dropout/mul_1' has no attr named '_XlaCompile'\r\n\r\n\r\nAs far as I have understood dropout layers should not be used in shap, since they are only used for training. But since this layer was written to explicitly also be used in prediction this probably leads to the problems. \r\nAre there any ideas on how I can bypass this?\r\n\r\n\r\nI use tensorflow 1.14 and the newest shap version from conda with python 3.6\r\n\r\n\r\n\r\n\r\n\r\n\r\nThanks in advance for any help.\r\n\r\nbest regard Tobias",
  "closed_by": {
    "login": "tobiasharren",
    "id": 49845179,
    "node_id": "MDQ6VXNlcjQ5ODQ1MTc5",
    "avatar_url": "https://avatars.githubusercontent.com/u/49845179?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tobiasharren",
    "html_url": "https://github.com/tobiasharren",
    "followers_url": "https://api.github.com/users/tobiasharren/followers",
    "following_url": "https://api.github.com/users/tobiasharren/following{/other_user}",
    "gists_url": "https://api.github.com/users/tobiasharren/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tobiasharren/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tobiasharren/subscriptions",
    "organizations_url": "https://api.github.com/users/tobiasharren/orgs",
    "repos_url": "https://api.github.com/users/tobiasharren/repos",
    "events_url": "https://api.github.com/users/tobiasharren/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tobiasharren/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/shap/shap/issues/1077/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/shap/shap/issues/1077/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
