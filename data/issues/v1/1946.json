{
  "url": "https://api.github.com/repos/shap/shap/issues/1946",
  "repository_url": "https://api.github.com/repos/shap/shap",
  "labels_url": "https://api.github.com/repos/shap/shap/issues/1946/labels{/name}",
  "comments_url": "https://api.github.com/repos/shap/shap/issues/1946/comments",
  "events_url": "https://api.github.com/repos/shap/shap/issues/1946/events",
  "html_url": "https://github.com/shap/shap/issues/1946",
  "id": 862652770,
  "node_id": "MDU6SXNzdWU4NjI2NTI3NzA=",
  "number": 1946,
  "title": "DeepExplainer.shap_values equal zero - Explainability different than CNN prediction",
  "user": {
    "login": "skiiz",
    "id": 19363395,
    "node_id": "MDQ6VXNlcjE5MzYzMzk1",
    "avatar_url": "https://avatars.githubusercontent.com/u/19363395?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/skiiz",
    "html_url": "https://github.com/skiiz",
    "followers_url": "https://api.github.com/users/skiiz/followers",
    "following_url": "https://api.github.com/users/skiiz/following{/other_user}",
    "gists_url": "https://api.github.com/users/skiiz/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/skiiz/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/skiiz/subscriptions",
    "organizations_url": "https://api.github.com/users/skiiz/orgs",
    "repos_url": "https://api.github.com/users/skiiz/repos",
    "events_url": "https://api.github.com/users/skiiz/events{/privacy}",
    "received_events_url": "https://api.github.com/users/skiiz/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2021-04-20T10:09:06Z",
  "updated_at": "2021-04-26T13:58:27Z",
  "closed_at": "2021-04-26T13:58:27Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "Hello,\r\nI am trying to explain a CNN with DeepExplainer. I get mainly two problems, that I would need your help on, please. It is for my thesis project and I am very stuck, I would be very grateful for any little help or directive.\r\n\r\n1 - With regard to a specific class (class2) I get DeepExplainer.shap_values = 0 for all input images. I find this strange as shap_values different than zero are to be found with regard to all the classes for input images of any class.\r\n\r\n2 - When explaining (calculating shap_values) for an input of class2, shap_values (blue and red pixels) are found in a another class, even if the CNN prediction is right and predicts class2 for this input.\r\n\r\nThe CNN is labelling a heat map dataset into 10 classes. I pass a background concatenated from samples from each class to the DeepExplainer. I tried with different background sizes and the problem still arise.\r\n\r\nMy images have this shape (754,27,3)\r\nMy background consequently have this shape (x10,754,27,3)\r\nshap_values for one input image have this shape (10,754,27,3)\r\nI assume then that shap_values[1, : , : , :] are related to the second class (class2), those are always 0.\r\n\r\nIn the figure there is three plots of calculated shap_values. I organize my shap_values in a (10,10,754,27,3), the first index is the input image 0 for an input of the first class, 1 for an input of second. Second index is the calculated shap_values with regard to what class.\r\nFollows the code I am using to build the background, load it to explainer, calculating shapley values. \r\n\r\nFigure 1 : plot of shap_values for an input of class3 with regard to class2 (zero, same case for all inputs with regard to this class)\r\nFigure 2 : plot of shap_values for an input of class2 with regard to class2 (zero)\r\nFigure 3 : plot of shap_values for an input of class2 with regard to class1 (we can see values)\r\n![Unbenannt1](https://user-images.githubusercontent.com/19363395/115376649-2b330c00-a1cf-11eb-821c-7791414deff4.PNG)\r\n![Unbenannt2](https://user-images.githubusercontent.com/19363395/115376652-2bcba280-a1cf-11eb-8531-915096e57a0b.PNG)\r\n![Unbenannt3](https://user-images.githubusercontent.com/19363395/115376655-2bcba280-a1cf-11eb-8240-72c4dba73fb5.PNG)\r\n\r\n\r\n```python\r\ncolors = [] \r\nfor l in np.linspace(1, 0, 100):\r\n    colors.append((245 / 255, 39 / 255, 87 / 255, l))\r\nfor l in np.linspace(0, 1, 100):\r\n    colors.append((24 / 255, 196 / 255, 93 / 255, l))\r\ncm = matplotlib.colors.LinearSegmentedColormap.from_list(\"shap\", colors\r\n\r\n\r\nnames = {0: 'class1', 1: 'class2', 2: 'class3', 3: 'class4', 4: 'class5', 5: 'class6',\r\n         6: 'class7', 7: 'class8', 8: 'class9', 9: 'class10'}\r\n\r\n\r\n#trainImages.shape=(x10, x1, 754, 27, 3)\r\nbackground = np.concatenate((trainImages[:, :, :, :, :]))\r\n\r\ne = shap.DeepExplainer(model, background)\r\nshapvalues=np.empty((10,10,754,27,3))\r\n\r\nfor i in range(0, 10):\r\n        thisImage = testImages[i, j, :, :, :]\r\n        thisImage = thisImage.reshape(754,27,3)\r\n        thisImage = thisImage.astype('float64')\r\n\r\n        shap_values = e.shap_values(thisImage.reshape(1, 754,27, 3))\r\n        shapvalues[i,:,:,:,:] = shap_values\r\n\r\n        shap.image_plot(shap_values1, thisImage.reshape(1, 754,27, 3), show=False)\r\n        plt.savefig('COB/30_1/plot'+str(i)+str(j), dpi = 1200)\r\n```",
  "closed_by": {
    "login": "skiiz",
    "id": 19363395,
    "node_id": "MDQ6VXNlcjE5MzYzMzk1",
    "avatar_url": "https://avatars.githubusercontent.com/u/19363395?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/skiiz",
    "html_url": "https://github.com/skiiz",
    "followers_url": "https://api.github.com/users/skiiz/followers",
    "following_url": "https://api.github.com/users/skiiz/following{/other_user}",
    "gists_url": "https://api.github.com/users/skiiz/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/skiiz/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/skiiz/subscriptions",
    "organizations_url": "https://api.github.com/users/skiiz/orgs",
    "repos_url": "https://api.github.com/users/skiiz/repos",
    "events_url": "https://api.github.com/users/skiiz/events{/privacy}",
    "received_events_url": "https://api.github.com/users/skiiz/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/shap/shap/issues/1946/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/shap/shap/issues/1946/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
