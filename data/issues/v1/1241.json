{
  "url": "https://api.github.com/repos/shap/shap/issues/1241",
  "repository_url": "https://api.github.com/repos/shap/shap",
  "labels_url": "https://api.github.com/repos/shap/shap/issues/1241/labels{/name}",
  "comments_url": "https://api.github.com/repos/shap/shap/issues/1241/comments",
  "events_url": "https://api.github.com/repos/shap/shap/issues/1241/events",
  "html_url": "https://github.com/shap/shap/issues/1241",
  "id": 627604615,
  "node_id": "MDU6SXNzdWU2Mjc2MDQ2MTU=",
  "number": 1241,
  "title": "TreeExplainer not returning expected_value in the presence of category type input using Lightgbm",
  "user": {
    "login": "waterknows",
    "id": 16784581,
    "node_id": "MDQ6VXNlcjE2Nzg0NTgx",
    "avatar_url": "https://avatars.githubusercontent.com/u/16784581?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/waterknows",
    "html_url": "https://github.com/waterknows",
    "followers_url": "https://api.github.com/users/waterknows/followers",
    "following_url": "https://api.github.com/users/waterknows/following{/other_user}",
    "gists_url": "https://api.github.com/users/waterknows/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/waterknows/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/waterknows/subscriptions",
    "organizations_url": "https://api.github.com/users/waterknows/orgs",
    "repos_url": "https://api.github.com/users/waterknows/repos",
    "events_url": "https://api.github.com/users/waterknows/events{/privacy}",
    "received_events_url": "https://api.github.com/users/waterknows/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 0,
  "created_at": "2020-05-30T00:05:57Z",
  "updated_at": "2020-05-30T00:05:57Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "To leverage lightgbm's [support for categorical features,](https://lightgbm.readthedocs.io/en/latest/Advanced-Topics.html) one of the way is to encode them into integers, and assign them 'category' type in pandas, then rely on categorical_feature == 'auto' for the fit API. After doing so in SHAP, however, the explainer would not output a expected value. SHAP decomposition however seems to be unaffected, which is weird since it would rely on knowing the E(y), or the expected value for SHAP values to be calculated, based on my understanding.\r\n```\r\nfrom sklearn.model_selection import train_test_split\r\nimport lightgbm as lgb\r\nX,y = shap.datasets.adult()\r\nX_display,y_display = shap.datasets.adult(display=True)\r\nX[['Workclass', 'Occupation']] = X[['Workclass', 'Occupation']].astype('category')\r\nX.info(verbose=True)\r\n# create a train/test split\r\nX_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=7)\r\nd_train = lgb.Dataset(X_train, label=y_train)\r\nd_test = lgb.Dataset(X_test, label=y_test)\r\n\r\nparams = {\r\n    \"max_bin\": 512,\r\n    \"learning_rate\": 0.05,\r\n    \"boosting_type\": \"gbdt\",\r\n    \"objective\": \"binary\",\r\n    \"metric\": \"binary_logloss\",\r\n    \"num_leaves\": 10,\r\n    \"verbose\": -1,\r\n    \"min_data\": 100,\r\n    \"boost_from_average\": True\r\n}\r\nmodel = lgb.train(params, d_train, 10000, valid_sets=[d_test], early_stopping_rounds=50, verbose_eval=1000)\r\nexplainer = shap.TreeExplainer(model)\r\nprint('Explainer base: ', explainer.expected_value)\r\nshap_values = explainer.shap_values(X)\r\n```\r\nSHAP version: 0.23.1\r\nlightgbm version: 2.3.1\r\npandas version: 1.0.3",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/shap/shap/issues/1241/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/shap/shap/issues/1241/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
