{
  "url": "https://api.github.com/repos/shap/shap/issues/1503",
  "repository_url": "https://api.github.com/repos/shap/shap",
  "labels_url": "https://api.github.com/repos/shap/shap/issues/1503/labels{/name}",
  "comments_url": "https://api.github.com/repos/shap/shap/issues/1503/comments",
  "events_url": "https://api.github.com/repos/shap/shap/issues/1503/events",
  "html_url": "https://github.com/shap/shap/issues/1503",
  "id": 715999817,
  "node_id": "MDU6SXNzdWU3MTU5OTk4MTc=",
  "number": 1503,
  "title": "Intermittent \"Additivity check failed in TreeExplainer!\" using sklearn RandomForest and \"tree_path_dependant\"",
  "user": {
    "login": "gsbowlin",
    "id": 43856047,
    "node_id": "MDQ6VXNlcjQzODU2MDQ3",
    "avatar_url": "https://avatars.githubusercontent.com/u/43856047?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/gsbowlin",
    "html_url": "https://github.com/gsbowlin",
    "followers_url": "https://api.github.com/users/gsbowlin/followers",
    "following_url": "https://api.github.com/users/gsbowlin/following{/other_user}",
    "gists_url": "https://api.github.com/users/gsbowlin/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/gsbowlin/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gsbowlin/subscriptions",
    "organizations_url": "https://api.github.com/users/gsbowlin/orgs",
    "repos_url": "https://api.github.com/users/gsbowlin/repos",
    "events_url": "https://api.github.com/users/gsbowlin/events{/privacy}",
    "received_events_url": "https://api.github.com/users/gsbowlin/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2020-10-06T20:28:04Z",
  "updated_at": "2020-10-08T13:10:04Z",
  "closed_at": "2020-10-08T13:10:04Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "Using shap 0.35.0, I'm seeing the `SHAPError: Additivity check failed in TreeExplainer!` error on a single point prediction, but only **randomly**.\r\n\r\nI have an sklearn.ensemble.RandomForestClassifier that is using shap to calculate feature contributions for predictions made using a pre-trained model (saved as a pickle from sklearn==0.19.2, numpy==1.16.4). \r\n\r\nWhen running the model, I get the Additivity check error **randomly**, while my input is static.\r\n\r\n```\r\n(Pdb) type(self.model)\r\n<class 'shap.explainers.tree.TreeEnsemble'>\r\n(Pdb) self.model.predict(X)\r\narray([[ 0.52882973, 71.47117027]])\r\n(Pdb) self.model.predict(X)\r\narray([[0.52882973, 0.47117027]])\r\n(Pdb) self.model.predict(X)\r\narray([[ 0.52882973, 71.47117027]])\r\n(Pdb) self.model.predict(X)\r\narray([[0.52882973, 0.47117027]])\r\n```\r\n\r\nWhat seems odd about this is that the predictions should sum to 1, but in this case, they either sum to 1, or to 72. \r\n\r\nI was actually able to trace this down into the c extension in `_cext_dense_tree_predict`. \r\n```\r\n(Pdb) output = np.zeros((X.shape[0], self.num_outputs))\r\n(Pdb) _cext.dense_tree_predict(self.children_left,self.children_right,self.children_default,self.features,self.thresholds,self.values,self.max_depth,tree_limit,self.base_offset,output_transform_codes[transform],X,X_missing,y,output)\r\n0.0009295774647887327\r\n(Pdb) output\r\narray([[0.52882973, 0.47117027]])\r\n(Pdb) output = np.zeros((X.shape[0], self.num_outputs))\r\n(Pdb) _cext.dense_tree_predict(self.children_left,self.children_right,self.children_default,self.features,self.thresholds,self.values,self.max_depth,tree_limit,self.base_offset,output_transform_codes[transform],X,X_missing,y,output)\r\n0.0009295774647887327\r\n(Pdb) output\r\narray([[ 0.52882973, 71.47117027]])\r\n```\r\n\r\n",
  "closed_by": {
    "login": "gsbowlin",
    "id": 43856047,
    "node_id": "MDQ6VXNlcjQzODU2MDQ3",
    "avatar_url": "https://avatars.githubusercontent.com/u/43856047?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/gsbowlin",
    "html_url": "https://github.com/gsbowlin",
    "followers_url": "https://api.github.com/users/gsbowlin/followers",
    "following_url": "https://api.github.com/users/gsbowlin/following{/other_user}",
    "gists_url": "https://api.github.com/users/gsbowlin/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/gsbowlin/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/gsbowlin/subscriptions",
    "organizations_url": "https://api.github.com/users/gsbowlin/orgs",
    "repos_url": "https://api.github.com/users/gsbowlin/repos",
    "events_url": "https://api.github.com/users/gsbowlin/events{/privacy}",
    "received_events_url": "https://api.github.com/users/gsbowlin/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/shap/shap/issues/1503/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/shap/shap/issues/1503/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
