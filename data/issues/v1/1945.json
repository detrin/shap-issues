{
  "url": "https://api.github.com/repos/shap/shap/issues/1945",
  "repository_url": "https://api.github.com/repos/shap/shap",
  "labels_url": "https://api.github.com/repos/shap/shap/issues/1945/labels{/name}",
  "comments_url": "https://api.github.com/repos/shap/shap/issues/1945/comments",
  "events_url": "https://api.github.com/repos/shap/shap/issues/1945/events",
  "html_url": "https://github.com/shap/shap/issues/1945",
  "id": 861132537,
  "node_id": "MDU6SXNzdWU4NjExMzI1Mzc=",
  "number": 1945,
  "title": "Error when using DeepExplainer on Keras model with TF feature_column layers",
  "user": {
    "login": "abeboparebop",
    "id": 2781883,
    "node_id": "MDQ6VXNlcjI3ODE4ODM=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2781883?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/abeboparebop",
    "html_url": "https://github.com/abeboparebop",
    "followers_url": "https://api.github.com/users/abeboparebop/followers",
    "following_url": "https://api.github.com/users/abeboparebop/following{/other_user}",
    "gists_url": "https://api.github.com/users/abeboparebop/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/abeboparebop/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/abeboparebop/subscriptions",
    "organizations_url": "https://api.github.com/users/abeboparebop/orgs",
    "repos_url": "https://api.github.com/users/abeboparebop/repos",
    "events_url": "https://api.github.com/users/abeboparebop/events{/privacy}",
    "received_events_url": "https://api.github.com/users/abeboparebop/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 8,
  "created_at": "2021-04-19T09:58:53Z",
  "updated_at": "2022-06-21T20:10:20Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "I'm running into a variety of issues trying to use the `DeepExplainer` with a Keras model that uses TensorFlow feature_column layers. Is this a bug in SHAP, or am I holding it wrong?\r\n\r\n1. SHAP doesn't accept a dictionary of features as input for defining the `DeepExplainer`, although the model itself does.\r\n2. I can pass a _list_ of inputs to create a `DeepExplainer`, but then trying to use the resulting explainer fails.\r\n\r\nHere's a gist showing the issue and error messages: https://gist.github.com/abeboparebop/7d4ad7ee57b4e47b419e55f12d634d86.\r\n\r\nAs far as I can tell, using a feature dict like this for raw inputs is the recommended way of combining Keras layers with TF feature_column layers, but I am not an expert. And FWIW, `GradientExplainer` fails with errors that seem like the underlying cause might be similar.\r\n\r\nHere's the stacktrace I get when trying to use the explainer to generate SHAP values (for future search engine users):\r\n\r\n```\r\nTypeError                                 Traceback (most recent call last)\r\nTypeError: only size-1 arrays can be converted to Python scalars\r\n\r\nThe above exception was the direct cause of the following exception:\r\n\r\nValueError                                Traceback (most recent call last)\r\n<ipython-input-15-69a8915f4869> in <module>\r\n----> 1 shap_values = e.shap_values([test_data[\"nf1\"], test_data[\"nf2\"]])\r\n\r\n/opt/miniconda/lib/python3.7/site-packages/shap/explainers/_deep/__init__.py in shap_values(self, X, ranked_outputs, output_rank_order, check_additivity)\r\n    122             were chosen as \"top\".\r\n    123         \"\"\"\r\n--> 124         return self.explainer.shap_values(X, ranked_outputs, output_rank_order, check_additivity=check_additivity)\r\n\r\n/opt/miniconda/lib/python3.7/site-packages/shap/explainers/_deep/deep_tf.py in shap_values(self, X, ranked_outputs, output_rank_order, check_additivity)\r\n    307                 # assign the attributions to the right part of the output arrays\r\n    308                 for l in range(len(X)):\r\n--> 309                     phis[l][j] = (sample_phis[l][bg_data[l].shape[0]:] * (X[l][j] - bg_data[l])).mean(0)\r\n    310 \r\n    311             output_phis.append(phis[0] if not self.multi_input else phis)\r\n\r\nValueError: setting an array element with a sequence.\r\n```",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/shap/shap/issues/1945/reactions",
    "total_count": 2,
    "+1": 2,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/shap/shap/issues/1945/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
