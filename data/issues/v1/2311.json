{
  "url": "https://api.github.com/repos/shap/shap/issues/2311",
  "repository_url": "https://api.github.com/repos/shap/shap",
  "labels_url": "https://api.github.com/repos/shap/shap/issues/2311/labels{/name}",
  "comments_url": "https://api.github.com/repos/shap/shap/issues/2311/comments",
  "events_url": "https://api.github.com/repos/shap/shap/issues/2311/events",
  "html_url": "https://github.com/shap/shap/issues/2311",
  "id": 1075845308,
  "node_id": "I_kwDOBHDcK85AIBi8",
  "number": 2311,
  "title": "ITE Explanations for a set of background vectors vs. average of explanations for individual background vectors",
  "user": {
    "login": "hkarloffgs",
    "id": 51752716,
    "node_id": "MDQ6VXNlcjUxNzUyNzE2",
    "avatar_url": "https://avatars.githubusercontent.com/u/51752716?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/hkarloffgs",
    "html_url": "https://github.com/hkarloffgs",
    "followers_url": "https://api.github.com/users/hkarloffgs/followers",
    "following_url": "https://api.github.com/users/hkarloffgs/following{/other_user}",
    "gists_url": "https://api.github.com/users/hkarloffgs/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/hkarloffgs/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/hkarloffgs/subscriptions",
    "organizations_url": "https://api.github.com/users/hkarloffgs/orgs",
    "repos_url": "https://api.github.com/users/hkarloffgs/repos",
    "events_url": "https://api.github.com/users/hkarloffgs/events{/privacy}",
    "received_events_url": "https://api.github.com/users/hkarloffgs/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 0,
  "created_at": "2021-12-09T17:53:23Z",
  "updated_at": "2021-12-09T17:53:23Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "Hi.  I am new to Shap so maybe I am misunderstanding something.  Fix one foreground vector x_f.  If one runs ITE Shap for a set of n background x_b vectors (by providing a 2-d data array with n rows), is the one explanation vector produced the average of the n explanation vectors produced by running ITE n times, each time with one x_b?  What baffles me is that this seems to be true for n <= 100 but not for n = 101.  Specifically, the code below produces:\r\n\r\nComparison for n = 100\r\naverage_of_n2_individual_shap_values = [-0.37261262]\r\nshap_value_for_Xb_size_n2 = [-0.37261262]\r\n\r\nComparison for n = 101\r\naverage_of_n2_individual_shap_values = [-0.36919098]\r\nshap_value_for_Xb_size_n2 = [-0.31180181]\r\n\r\nIs the conjecture true for n <= 100 but not for larger n?   If not, then how is the explanation vector computed for n > 100, if not by averaging the individual explanation vectors? \r\n\r\nThanks!\r\n\r\nimport numpy as np\r\nfrom sklearn.ensemble import RandomForestClassifier\r\nimport shap\r\n\r\ndata_list = [\r\n  [0.027101115983838242], [0.7587882070805022], [0.5080453146205635], [0.2986089253950448], [0.3049142294667543],\r\n  [0.08323751007719427], [0.38469388048353115], [0.8151520216082166], [0.8565741304821173], [0.6049263927431725],\r\n  [0.4974301811307056], [0.7181333223835884], [0.4355887469015264], [0.13848117781746017], [0.19495877062689593],\r\n  [0.36230375412030036], [0.67637388140599], [0.4854535890893772], [0.4681394326422319], [0.8034162901690326],\r\n  [0.9763351477855261], [0.6337004496180567], [0.9209656249549795], [0.471907118766961], [0.48344075488201044],\r\n  [0.6435432113297612], [0.7236485620058897], [0.43891896440591016], [0.9347350275475891], [0.43100456792050856],\r\n  [0.6092331624185044], [0.8954451571792771], [0.9043217653556372], [0.1858474142756089], [0.8981156834828236],\r\n  [0.19968102699362633], [0.05951869845897295], [0.10946289425700817], [0.27337476226400415], [0.8598296698866017],\r\n  [0.9457104341723166], [0.327098954945399], [0.8411404751211422], [0.8722539201489856], [0.40602920718364144],\r\n  [0.2202195085915415], [0.3200990951446768], [0.3033302293985771], [0.9469763225030657], [0.32614133485599095],\r\n  [0.13133586144968368], [0.5648243368240651], [0.12391485812315772], [0.7168174954319049], [0.4807004835294455],\r\n  [0.2020288297696663], [0.755380472552977], [0.3685606049122746], [0.8058737945802308], [0.9743555469742733],\r\n  [0.45492008330451095], [0.7619129626604463], [0.9242573607552167], [0.7279108321817673], [0.8358006022756295],\r\n  [0.0005698051114176872], [0.15431748170298454], [0.16254644690243458], [0.7485651462601767], [0.36443070359850216],\r\n  [0.6190197621156337], [0.1253708843999285], [0.5436082531117704], [0.431749233886482], [0.6099676869096831],\r\n  [0.08516514819024623], [0.8719934315050925], [0.6803588601522478], [0.8823232782298328], [0.6654751147771328],\r\n  [0.31342904534478777], [0.22860112840989022], [0.34711393164032445], [0.5398744667057298], [0.9905591788521318],\r\n  [0.7651597463498439], [0.9785829800020841], [0.30030069221141087], [0.2891361185821455], [0.17614380645841654],\r\n  [0.3779254939170802], [0.979164231350976], [0.20576596260145197], [0.26642589855332244], [0.6268079324543377],\r\n  [0.1713879825549498], [0.3002478172123966], [0.23979302545276915], [0.19174649979607827], [0.05160100956936331],\r\n  [0.5157907074595192]]\r\nX = np.array(data_list)\r\ny_list = [0, 0, 0, 1, 0, 0, 0, 1, 1, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 1,\r\n  1, 0, 0, 0, 0, 1, 0, 1, 1, 1, 0, 0, 0, 1, 1, 0, 0,\r\n  1, 0, 0, 0, 1, 1, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0,\r\n  1, 0, 0, 0, 1, 0, 0, 0, 1, 1, 0, 0, 0, 1, 1, 0, 0, 0, 1, 0, 0, 1, 0, 1, 0, 0,\r\n  1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 0, 1, 0, 0, 1, 0, 1]\r\ny = np.array(y_list)\r\nnumRows = X.shape[0]\r\nmodel = RandomForestClassifier(n_estimators=111, random_state=0).fit(X, y)\r\n\r\nxf = np.zeros((1, 1))\r\nxf[0, 0] = 0.93\r\n\r\nfor n in range(100, 102):\r\n  X_first_n_lines = X[:n, :]\r\n\r\n  running_sum_of_n_shap_values = 0.0\r\n\r\n  for i in range(X_first_n_lines.shape[0]):\r\n      xb_i = X[i:i+1, :]\r\n      explainer_ite_i = shap.TreeExplainer(model, feature_perturbation=\"interventional\", data=xb_i)\r\n      shap_values_ite_i = explainer_ite_i.shap_values(xf)\r\n      running_sum_of_n_shap_values += shap_values_ite_i[0][0]\r\n\r\n  average_of_n_shap_values = running_sum_of_n_shap_values / n\r\n\r\n  assert X_first_n_lines.shape[0] == n\r\n  explainer_ite = shap.TreeExplainer(model, feature_perturbation=\"interventional\", data=X_first_n_lines)\r\n  shap_values_ite_n2 = explainer_ite.shap_values(xf)\r\n\r\n  print(\"\\nComparison for n =\", n)\r\n  print(\"average_of_n2_individual_shap_values =\", average_of_n_shap_values)\r\n  print(\"shap_value_for_Xb_size_n2 =\", shap_values_ite_n2[0][0])\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/shap/shap/issues/2311/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/shap/shap/issues/2311/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
