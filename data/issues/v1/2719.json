{
  "url": "https://api.github.com/repos/shap/shap/issues/2719",
  "repository_url": "https://api.github.com/repos/shap/shap",
  "labels_url": "https://api.github.com/repos/shap/shap/issues/2719/labels{/name}",
  "comments_url": "https://api.github.com/repos/shap/shap/issues/2719/comments",
  "events_url": "https://api.github.com/repos/shap/shap/issues/2719/events",
  "html_url": "https://github.com/shap/shap/issues/2719",
  "id": 1402220156,
  "node_id": "I_kwDOBHDcK85TlC58",
  "number": 2719,
  "title": "SHAP library does not support TransformedTargetRegressor, how to calculate SAHP in native units with target transform",
  "user": {
    "login": "valentasgruzauskas",
    "id": 23154503,
    "node_id": "MDQ6VXNlcjIzMTU0NTAz",
    "avatar_url": "https://avatars.githubusercontent.com/u/23154503?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/valentasgruzauskas",
    "html_url": "https://github.com/valentasgruzauskas",
    "followers_url": "https://api.github.com/users/valentasgruzauskas/followers",
    "following_url": "https://api.github.com/users/valentasgruzauskas/following{/other_user}",
    "gists_url": "https://api.github.com/users/valentasgruzauskas/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/valentasgruzauskas/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/valentasgruzauskas/subscriptions",
    "organizations_url": "https://api.github.com/users/valentasgruzauskas/orgs",
    "repos_url": "https://api.github.com/users/valentasgruzauskas/repos",
    "events_url": "https://api.github.com/users/valentasgruzauskas/events{/privacy}",
    "received_events_url": "https://api.github.com/users/valentasgruzauskas/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "open",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 1,
  "created_at": "2022-10-09T09:51:42Z",
  "updated_at": "2023-01-15T09:45:12Z",
  "closed_at": null,
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "We are working with a regression problem, where we want to apply log transform to target variable. After model training, we want to obtain SHAP values in native units, that they would be suitable for end-user.\r\n\r\nWhen trying to create an explainer by using SHAP library, we receive the folowing error:\r\n`shap.utils._exceptions.InvalidModelError: Model type not yet supported by TreeExplainer: <class 'sklearn.compose._target.TransformedTargetRegressor'>`\r\n\r\nI can manualy apply reverse transformation to obtain final prediction correctly, however, I want to receive each SHAP value for individual feature in native units. How could I do it?\r\n\r\n```\r\nLightGBM prediction with target transform: [24.23973864]\r\nSHAP explainer estimated value with manual reverse_tranform of final value: 24.23973864452016\r\nSHAP explainer estimated value with manual reverse_tranform of intermediate values: 21.04059855102976\r\n```\r\n\r\nReproducable example:\r\n```\r\nimport numpy as np\r\nfrom lightgbm import LGBMRegressor\r\nimport shap\r\nfrom sklearn.pipeline import make_pipeline\r\nfrom sklearn.compose import TransformedTargetRegressor\r\n\r\n#get data set\r\nX, y = shap.datasets.boston()\r\n\r\n#Create model with target transform\r\npipeline = make_pipeline(\r\n    LGBMRegressor()\r\n)\r\n\r\nmodel_with_target_transform = TransformedTargetRegressor(regressor=pipeline, func=np.log1p, inverse_func=np.expm1)\r\nmodel_with_target_transform.fit(X, y)\r\n\r\n#Create model without target transform, but with transform\r\ny = np.log1p(y)\r\nmodel_without_target_trasnsform = LGBMRegressor()\r\nmodel_without_target_trasnsform.fit(X, y)\r\n\r\n#Select observation for testing purpose\r\ntest = X.iloc[:1]\r\n\r\n# Calculate prediction with target transform\r\nlightgbm_prediction_with_target_transform = model_with_target_transform.predict(test)\r\n\r\n# Create explainer\r\n# Explainer with target transform is not supported\r\n# explainer = shap.TreeExplainer(model_with_target_transform)\r\n# shap.utils._exceptions.InvalidModelError: Model type not yet supported by TreeExplainer: <class 'sklearn.compose._target.TransformedTargetRegressor'>\r\n\r\nexplainer = shap.TreeExplainer(model_without_target_trasnsform)\r\nexplained = explainer(test)\r\n\r\n# Manualy inverse transform shap values\r\nshap_prediction_all_transform = np.expm1(explained.base_values[0] + sum(explained.values[0]))\r\nshap_prediction_seperate_transform = np.expm1(explained.base_values[0]) + sum(np.expm1(explained.values[0]))\r\n\r\nprint(f\"LightGBM prediction with target transform: {lightgbm_prediction_with_target_transform}\")\r\n\r\n# Manual conversion of shap values to estimation, reverse transformation of shap values + base values is correct.\r\n# Seperate values reverse transformation and than sum is incorrect\r\nprint(f\"SHAP explainer estimated value with manual reverse_tranform of final value: {shap_prediction_all_transform}\")\r\nprint(f\"SHAP explainer estimated value with manual reverse_tranform of intermediate values: {shap_prediction_seperate_transform}\")\r\n```",
  "closed_by": null,
  "reactions": {
    "url": "https://api.github.com/repos/shap/shap/issues/2719/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/shap/shap/issues/2719/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
