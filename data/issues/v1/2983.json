{
  "url": "https://api.github.com/repos/shap/shap/issues/2983",
  "repository_url": "https://api.github.com/repos/shap/shap",
  "labels_url": "https://api.github.com/repos/shap/shap/issues/2983/labels{/name}",
  "comments_url": "https://api.github.com/repos/shap/shap/issues/2983/comments",
  "events_url": "https://api.github.com/repos/shap/shap/issues/2983/events",
  "html_url": "https://github.com/shap/shap/pull/2983",
  "id": 1750835269,
  "node_id": "PR_kwDOBHDcK85SrIoB",
  "number": 2983,
  "title": "Handling tf import issue in pyspark.",
  "user": {
    "login": "skamdar",
    "id": 10262159,
    "node_id": "MDQ6VXNlcjEwMjYyMTU5",
    "avatar_url": "https://avatars.githubusercontent.com/u/10262159?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/skamdar",
    "html_url": "https://github.com/skamdar",
    "followers_url": "https://api.github.com/users/skamdar/followers",
    "following_url": "https://api.github.com/users/skamdar/following{/other_user}",
    "gists_url": "https://api.github.com/users/skamdar/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/skamdar/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/skamdar/subscriptions",
    "organizations_url": "https://api.github.com/users/skamdar/orgs",
    "repos_url": "https://api.github.com/users/skamdar/repos",
    "events_url": "https://api.github.com/users/skamdar/events{/privacy}",
    "received_events_url": "https://api.github.com/users/skamdar/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [

  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [

  ],
  "milestone": null,
  "comments": 2,
  "created_at": "2023-06-10T06:45:39Z",
  "updated_at": "2023-06-11T02:41:25Z",
  "closed_at": "2023-06-11T02:41:24Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/shap/shap/pulls/2983",
    "html_url": "https://github.com/shap/shap/pull/2983",
    "diff_url": "https://github.com/shap/shap/pull/2983.diff",
    "patch_url": "https://github.com/shap/shap/pull/2983.patch",
    "merged_at": "2023-06-11T02:41:24Z"
  },
  "body": "While Calling Gradient Explainer's shap_values method inside a pyspark UDF, it gives NoneType object has no attribute executing_eagerly. This happens because the global tf variable used inside this method is not initialized on worker node since import tf happens within init of _TFGradient class, which is executed on master only once. Same thing happens with torch as well. This behaviour is observed for picklable tf models.\r\n\r\nExample Codebase:\r\n\r\n```\r\nfrom pyspark.sql.types import StructType, StructField, FloatType, StringType, ArrayType\r\nimport pyspark.sql.functions as F\r\n\r\nimport shap\r\n\r\nexplainer = shap.GradientExplainer(model, background_data)\r\n\r\ndef calculate_shap_udf(x, params):\r\n    x = np.array([x])\r\n    shap_values = explainer.shap_values(x, **params)\r\n    return shap_values[0].tolist()\r\n\r\nshap_udf = F.udf(lambda x: calculate_shap_udf(x, params_dict), ArrayType(FloatType()))\r\n\r\ndata_df = data_df.withColumn(\"shap_values\", shap_udf(F.col(\"features\")))\r\n\r\n```\r\nAs part of the change we have added import statements within shap_values method while declaring tf and keras as global variables. Same declaration for these variables is done in other methods as well so that global copy of these variables are used by respective methods. The import statement is executed once only, subsequent calls will be just sys.modules dict lookups by import machinery. In case of distributed scenario the import will be done once per python worker.",
  "closed_by": {
    "login": "thatlittleboy",
    "id": 30731072,
    "node_id": "MDQ6VXNlcjMwNzMxMDcy",
    "avatar_url": "https://avatars.githubusercontent.com/u/30731072?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/thatlittleboy",
    "html_url": "https://github.com/thatlittleboy",
    "followers_url": "https://api.github.com/users/thatlittleboy/followers",
    "following_url": "https://api.github.com/users/thatlittleboy/following{/other_user}",
    "gists_url": "https://api.github.com/users/thatlittleboy/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/thatlittleboy/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/thatlittleboy/subscriptions",
    "organizations_url": "https://api.github.com/users/thatlittleboy/orgs",
    "repos_url": "https://api.github.com/users/thatlittleboy/repos",
    "events_url": "https://api.github.com/users/thatlittleboy/events{/privacy}",
    "received_events_url": "https://api.github.com/users/thatlittleboy/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/shap/shap/issues/2983/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/shap/shap/issues/2983/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
